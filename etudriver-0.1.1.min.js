/*! etudriver 07-01-2014 */
!function(a){"use strict";function b(a,b,c){this.ts=a,this.x=b,this.y=c,this.duration=0,this.saccade={dx:0,dy:0},this.samples=[]}function c(){var a=n.headCorrector.transformParam,b=null,c=function(a){var b=0,c=0,d=0;return a.xl&&(c+=a.xl,d+=a.yl,b+=1),a.xr&&(c+=a.xr,d+=a.yr,b+=1),b&&(c/=b,d/=b),{x:c,y:d}};this.init=function(a){b=c(a)},this.correct=function(d,e){var f=c(e),g=(f.x-b.x)*a,h=(f.y-b.y)*a;return{x:Math.round(d.x-g),y:Math.round(d.y+h)}}}function d(){this.x=-1,this.y=-1,this.t=0,this.interval=0,this.buffer=[],this.init=function(){this.x=-1,this.y=-1,this.t=0,this.buffer=[]},this.smooth=function(a,b,c){var d=n.pointer.smoothing;this.x<0&&this.y<0&&0===this.t&&(this.x=b,this.y=c,this.t=d.low);var e,f=0,g=0,h=0,i=0,j=0,k=0,l=!1;for(this.buffer.push({ts:a,x:b,y:c}),e=0;e<this.buffer.length;e+=1){var m=this.buffer[e],o=a-m.ts;o>2*d.timeWindow?(this.buffer.shift(),l=!0):o>d.timeWindow?(f+=m.x,g+=m.y,j++):(h+=m.x,i+=m.y,k++)}if(j&&k){f/=j,g/=j,h/=k,i/=k;var p=f-h,q=g-i,r=Math.sqrt(p*p+q*q);this.t=r>d.threshold?d.high:d.low}if(l&&!this.interval&&this.buffer.length>1){var s=0;for(e=1;e<this.buffer.length;e+=1)s+=this.buffer[e].ts-this.buffer[e-1].ts;this.interval=s/(this.buffer.length-1)}if(this.interval){var t=this.t/this.interval;this.x=(b+t*this.x)/(1+t),this.y=(c+t*this.y)/(1+t)}return{x:this.x,y:this.y}}}function e(a,b,c,d,e){this.matched=0,this.ts=a,this.x=b,this.y=c,this.ec=d,this.focused=e}function f(a){this.rules=a,this.buffer=[],this.eventIsOn=!1,this.canTest=!1,this.current=null}function g(a,b,c){this.ec=b||{xl:0,yl:0,xr:0,yr:0},this.timestamp=a||-1,this.focused=c||null}function h(a,b,c,d){this.xl=a||0,this.yl=b||0,this.xr=c||0,this.yr=d||0}function i(a,b){this.left=a||0,this.right=b||0}function j(a){var b=a,c=null,d=.3,e=.8,f=2e3,g=[],j=[],k=null,l=0,m=!1,o=!0,p=null,q=0,r=0,s=null,t=new h,u=n.customHeadGestureDetector.calibration.trials,v=document.createElement("div");v.id="etud-chgd-calibOverlay",v.innerHTML='        <div id="etud-chgd-calib">            <a id="etud-chgd-calibClose" href="#">X</button>        </div>',document.body.insertBefore(v,document.body.firstChild);var w=this;document.getElementById("etud-chgd-calibClose").addEventListener("click",function(){return w.hide(!0),!1});var x=document.createElement("canvas");x.id="etud-chgd-calibCanvas",x.width=Math.round(320*n.customHeadGestureDetector.calibration.plotSizeFactor),x.height=Math.round(240*n.customHeadGestureDetector.calibration.plotSizeFactor),document.getElementById("etud-chgd-calib").appendChild(x);var y=x.getContext("2d"),z=function(a,b,c,d,e){for(var f=-1,g=n.customHeadGestureDetector.calibration.threshold,h=a[b],i=c;e>0?d>i:i>=d;i+=e){var j=a[i],k=j.ec.xl-h.ec.xl,l=j.ec.yl-h.ec.yl,m=j.ec.xr-h.ec.xr,o=j.ec.yr-h.ec.yr,p=Math.sqrt(k*k+l*l),q=Math.sqrt(m*m+o*o);if(p>g||q>g){f=i;break}}return f},A=function(){return Math.max(5,q-Math.max(2*r,.2*q))},B=function(){return Math.max(10,q+Math.max(2*r,.2*q))},C=function(a,b,c){var d=new h;if(c>b){for(var e=b;c>=e;e+=1){var f=a[e];d.xl+=f.ec.xl,d.yl+=f.ec.yl,d.xr+=f.ec.xr,d.yr+=f.ec.yr}var g=c-b+1;d.xl/=g,d.yl/=g,d.xr/=g,d.yr/=g}return d},D=function(a,b,c,d){if(c>b)for(var e=b;c>=e;e+=1){var f=a[e];f.ec.xl-=d.xl,f.ec.yl-=d.yl,f.ec.xr-=d.xr,f.ec.yr-=d.yr}},E=function(a,b,c,d){var e={error:new i,correl:new i};if(c>b){for(var f=new i,g=new i,j=new i,k=new i,l=new i,m=b;c>=m;m+=1){var n=Math.round((m-b)/(c-b)*(s.length-1)),o=s[n],p=a[m],q=new h(p.ec.xl-d.xl,p.ec.yl-d.yl,p.ec.xr-d.xr,p.ec.yr-d.yr);e.error.left+=Math.sqrt(Math.pow(q.xl-o.xl,2)+Math.pow(q.yl-o.yl,2)),e.error.right+=Math.sqrt(Math.pow(q.xr-o.xr,2)+Math.pow(q.yr-o.yr,2));var r=new i(Math.sqrt(Math.pow(q.xl,2)+Math.pow(q.yl,2)),Math.sqrt(Math.pow(q.xr,2)+Math.pow(q.yr,2))),u=new i(Math.sqrt(Math.pow(o.xl,2)+Math.pow(o.yl,2)),Math.sqrt(Math.pow(o.xr,2)+Math.pow(o.yr,2)));f.left+=r.left*u.left,g.left+=r.left,j.left+=u.left,k.left+=Math.pow(r.left,2),l.left+=Math.pow(u.left,2),f.right+=r.right*u.right,g.right+=r.right,j.right+=u.right,k.right+=Math.pow(r.right,2),l.right+=Math.pow(u.right,2)}var v=new i(Math.sqrt(Math.pow(t.xl,2)+Math.pow(t.yl,2)),Math.sqrt(Math.pow(t.xr,2)+Math.pow(t.yr,2))),w=c-b+1;e.error.left=e.error.left/w/v.left,e.error.right=e.error.right/w/v.right;try{e.correl.left+=(w*f.left-g.left*j.left)/Math.sqrt(w*k.left-Math.pow(g.left,2))/Math.sqrt(w*l.left-Math.pow(j.left,2)),e.correl.right+=(w*f.right-g.right*j.right)/Math.sqrt(w*k.right-Math.pow(g.right,2))/Math.sqrt(w*l.right-Math.pow(j.right,2))}catch(x){}}return e},F=function(a,b,c,d,e){if(c>b)for(var f=b;c>=f;f++){var g=Math.round((f-b)/(c-b)*(s.length-1)),h=s[g],i=a[f];h.xl=(1-e)*h.xl+e*(i.ec.xl-d.xl),h.yl=(1-e)*h.yl+e*(i.ec.yl-d.yl),h.xr=(1-e)*h.xr+e*(i.ec.xr-d.xr),h.yr=(1-e)*h.yr+e*(i.ec.yr-d.yr)}},G=function(){for(var a=0;a<g.length;a+=1){var b=g[a];b.length<2&&(g.splice(a,1),a-=1)}},H=function(a,b){for(var c=0,d=0,e=0;e<a.length;e+=1)a[e]!=b&&(c+=a[e],d+=1);return d?c/d:0},I=function(a,b,c){for(var d=0,e=0,f=0;f<a.length;f+=1)a[f]!=c&&(d+=Math.pow(a[f]-b,2),e+=1);return e?Math.sqrt(d/e):0},J=function(a){for(var b=Number.MIN_VALUE,c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=Number.MAX_VALUE,f=Number.MIN_VALUE,g=Number.MAX_VALUE,i=Number.MIN_VALUE,j=Number.MAX_VALUE,k=0;k<a.length;k+=1){var l=a[k];b<l.xl&&(b=l.xl),c>l.xl&&(c=l.xl),d<l.yl&&(d=l.yl),e>l.yl&&(e=l.yl),f<l.xr&&(f=l.xr),g>l.xr&&(g=l.xr),i<l.yr&&(i=l.yr),j>l.yr&&(j=l.yr)}return new h(b-c,d-e,f-g,i-j)},K=function(a,b){var c=[];q=H(a,0),r=I(a,q,0);var d,e,f,i,j=(new h,Math.round(q));for(d=0;j>d;d+=1){var k=d/(j-1),l=new h,m=0;for(e=0;e<g.length;e+=1)a[e]&&(f=b[e]+Math.round(k*a[e]),i=g[e][f],l.xl+=i.ec.xl,l.yl+=i.ec.yl,l.xr+=i.ec.xr,l.yr+=i.ec.yr,m+=1);m&&(l.xl/=m,l.yl/=m,l.xr/=m,l.yr/=m),c.push(l)}return c},L=function(){var a,b,c=[],d=[],e=0,f=n.customHeadGestureDetector.calibration.threshold;for(a=0;a<g.length;a+=1){var h=g[a];c[a]=z(h,0,1,h.length,1),b=z(h,h.length-1,h.length-2,0,-1);var i=c[a]<0?h.length-1:c[a]-1,j=C(h,0,i),k=0>b?0:b+1,l=C(h,k,h.length-1);D(h,0,h.length-1,j);var m=Math.sqrt(Math.pow(j.xl-l.xl,2)+Math.pow(j.yl-l.yl,2)),o=Math.sqrt(Math.pow(j.xr-l.xr,2)+Math.pow(j.yr-l.yr,2));c[a]>=0&&b>=0&&c[a]<b&&f>m&&f>o?d.push(b-c[a]+1):(d.push(0),e++)}return{startIndexes:c,durations:d,zeroSignalSizeCount:e}},M=function(){if(!(g.length<u)){G();var a=L(),b=a.zeroSignalSizeCount<g.length/2;b&&(s=K(a.durations,a.startIndexes),t=J(s))}},N=function(){y.fillStyle="white",y.fillRect(0,0,x.width,x.height),j.length>0&&O(j)},O=function(a){var b=x.width,c=x.height,d=24;y.font=d+"px Arial",y.textAlign="center",y.textBaseline="middle",y.fillStyle="#444",a.forEach(function(e,f){y.fillText(e,Math.round(b/2),Math.round(c/2)+1.5*d*(f-(a.length-1)/2))})},P=function(a){var b=x.width,c=x.height,d=function(d){y.beginPath();for(var e=0;e<a.length;e+=1){var f=a[e];0===e?y.moveTo(f.ec["x"+d]*b,f.ec["y"+d]*c):y.lineTo(f.ec["x"+d]*b,f.ec["y"+d]*c)}y.stroke()};y.strokeStyle="black",y.lineWidth=2,a&&(d("l"),d("r"))},Q=function(a){var b=x.width,c=x.height;y.fillStyle="red",y.beginPath(),y.arc(a.ec.xl*b,a.ec.yl*c,3,0,2*Math.PI),y.arc(a.ec.xr*b,a.ec.yr*c,3,0,2*Math.PI),y.fill()},R=function(){m=!1},S=function(a){p=null;var b=0;l+=1,2*u>l?l%2===1?(k=[],g.push(k),b=n.customHeadGestureDetector.calibration.trialDuration,j=[],c&&c("start")):(k=null,b=n.customHeadGestureDetector.calibration.pauseDuration,j=["Gesture recorded","Prepare for the next"],c&&c("stop")):l===2*u?(k=null,b=1e3,j=[],c&&c("stop")):l===2*u+1?(j=["Processing data","Please wait..."],N(),c&&c("processing"),M(),b=2e3,j=["Done!"],c&&c("processed")):l===2*(u+1)&&(j=[],a.hide(!0),c&&c("finished")),N(),b&&(p=setTimeout(S,b,a))};this.getBufferSize=function(){return q+4*r+20},this.init=function(a){c=a,g=[],s=null,k=null,l=0,m=!1,o=!0,this.show(),p=setTimeout(S,f+1500,this),j=["Task: "+u+" head gesture"+(u>1?"s":""),"Prepare for the first gesture"],N()},this.finilize=function(){k=null},this.detect=function(a,b){var c={detected:!1};if(!s)return c;var f,g=z(a,0,1,a.length-1,1),h=z(a,a.length-1,a.length-1,0,-1),j={error:new i,correl:new i},k=h-g+1;return g>0&&h>0&&h>g&&k>A()&&k<B()&&(c.detected=!0,f=C(a,0,g-1),j=E(a,g,h,f),(j.error.left>d||j.error.right>d||j.correl.left<e||j.correl.right<e)&&(c.detected=!1,o=!0),c.detected&&b&&o&&g>10&&h<a.length-1&&(F(a,g,h,f,.3),o=!1)),c.detected&&(c.detected=a[g-1].focused),c.detected&&!m&&(m=!0,setTimeout(R,1e3)),c},this.feed=function(a){k&&k.push(a),N(),0===j.length&&(P(k),Q(a))},this.show=function(){v.style.display="block"},this.hide=function(a){v.style.display="none",p&&(clearTimeout(p),p=null),a&&b&&b()}}function k(a){this.modes={none:0,calibration:1,training:2,detection:3},this.current=null;var b=new j(function(){}),c=a,d=this.modes.none,e=null,f=!1,h=0,i=new g,k=!0,l=function(a,b){var c,d=e.length;for(c=e.length-1;c>=0;c-=1)if(e[c].isValid()){d=c;break}if(d<e.length){var f=e.length-d,h=e[d];for(c=d+1;c<e.length;c+=1){var i=(c-d)/f;e[c]=new g(h.timestamp+(a-h.timestamp)*i,{xl:h.ec.xl+(b.xl-h.xl)*i,yl:h.ec.yl+(b.yl-h.yl)*i,xr:h.ec.xr+(b.xr-h.xr)*i,yr:h.ec.yr+(b.yr-h.yr)*i},e[c].focused)}}},m=function(a){var c=a-h>n.customHeadGestureDetector.detection.minPause,g=n.customHeadGestureDetector.detection.alterRefSignalOnDetection&&!f&&c,j={};return d===this.modes.training?(j=b.detect(e,g),b.feed(i)):d===this.modes.detection&&(j=b.detect(e,g),!f&&c&&(j.valid=!0)),j.detected&&(h=a),f=!!j.detected,j};this.getName=function(){return c},this.init=function(a,c){d=a,this.current=null,e=d===this.modes.calibration?null:[],f=!1,h=0,i=new g,k=!0,d===this.modes.calibration&&b.init(c)},this.finilize=function(){b.finilize(),e=null,d=this.modes.none},this.feed=function(a,c,f){if(d==this.modes.none)return null;var h=!0;if(i.isSet()){var j=i.ec.xl-c.xl,n=i.ec.yl-c.yl,o=i.ec.xr-c.xr,p=i.ec.yr-c.yr;h=Math.sqrt(Math.pow(j,2)+Math.pow(n,2))<.2&&Math.sqrt(Math.pow(o,2)+Math.pow(p,2))<.2}if(h?(i=new g(a,c,f),!k&&e&&e.length>0&&l(a,c)):i.timestamp=-1,k=h,d===this.modes.calibration)b.feed(i);else if(e.length===b.getBufferSize()){if(e.shift(),e.push(i),h){var q=m.call(this,a);this.current=q.valid?q.detected:null}}else e.push(i);return this.current}}function l(a,b,c){function d(a){var b=a,c=150,d=150,e=300,f=12,g=20,h=function(a){var h=Math.log((b.dwellTime+d)/e)*f;h+=a,b.dwellTime=Math.round((e*Math.exp(h/f)-d)/g)*g,b.dwellTime<c&&(b.dwellTime=c)};this.increase=function(){h(1)},this.decrease=function(){h(-1)}}this.options=a;var e={};e.layout=a.layout||'["!|!|1,?|?|2,:|:|3,;|;|4,\\u0027|\\u0027|5,\\u0022|\\u0022|6,&|&|7,@|@|8,(|(|9,)|)|0",{"titles":["backspace.png"], "commands":["backspace"]}],\n["q|Q|+,w|W|-:,e|E|*,r|R|\\/,t|T|=,y|Y|%,u|U|$,i|I|#,o|O|(,p|P|)",{"titles":["enter.png"], "commands":["enter"]}],\n["a|A|@,s|S|~,d|D|^,f|F|\\u005C,g|G|_,h|H|&,j|J|[,k|K|],l|L|\\u007B, | |\\u007D",{"titles":["symbols.png","symbols.png","upcase.png"], "commands":["symbols","symbols","upcase"]}],\n["z|Z|,x|X|,c|C|,v|V|,b|B| ,n|N|,m|M|",{"titles":[",","<","<"], "commands":[",","<","<"]},".|>|>",{"titles":["upcase.png","lowcase.png"], "commands":["upcase","lowcase"]},{"titles":["send.png"], "commands":["custom"]}]',e.callbacks=a.callbacks||{},e.imageFolder=a.imageFolder||"/images/kbd/"+a.name+"/",e.className={container:"etud-keyboard "+((a.className?a.className.container:"")||"etud-keyboardDefault"),button:"etud-keyboard-button "+((a.className?a.className.button:"")||"etud-keyboard-buttonDefault")};var f=c||{},g=document.createElement("table");g.className=e.className.container,g.classList.add("etud-keyboard-invisible");var h=0,i={lowcase:0,upcase:1,symbols:2},j={dwell:"dwell"},k=[],l=null,m=new d(a.selection),n=this,o={hide:function(){F()},backspace:function(){var a=l||document.activeElement;if(a){var b=a.selectionStart,c=a.value;if(void 0!==b&&void 0!==c&&b>0){var d=c.substr(0,b-1),e=c.substr(b);a.value=d+e,a.selectionStart=b-1,a.selectionEnd=b-1}}},enter:function(){s("Enter",13)},left:function(){s("Left",37)},right:function(){s("Left",39)},up:function(){s("Up",38)},down:function(){s("Down",40)},home:function(){s("Home",36)},end:function(){s("End",35)},pageup:function(){s("PageUp",33)},pagedown:function(){s("PageDown",34)},dwellInc:function(){m.increase()},dwellDec:function(){m.decrease()},custom:function(a){a in e.callbacks&&e.callbacks[a](n)}},p=function(b){return b===j.dwell?a.selection.dwellTime:void 0},q=function(a,b,c){var d=p(c);d!=a.indicator.value&&(a.indicator.value=d,b.innerHTML=d)},r=function(a,b){var c=Object.prototype.toString.call(b).slice(8,-1);return void 0!==b&&null!==b&&c===a},s=function(a,b){function c(a){if("textarea"==a.tagName.toLowerCase()){var b=a.value.substr(0,a.selectionEnd),c=a.value.substr(a.selectionEnd);a.value=b+"\n"+c}else{var d=new KeyboardEvent("keydown",{key:"Enter",code:13,shiftKey:!1});a.dispatchEvent(d)}}function d(a){a.selectionEnd=a.selectionStart=a.value.lastIndexOf("\n",a.selectionEnd-1)+1}function e(a){var b=a.selectionEnd,c=a.value.indexOf("\n",b);-1===c&&(c=a.value.length),a.selectionStart=a.selectionEnd=c}function f(a){a.selectionStart=a.selectionEnd-=1}function g(a){a.selectionStart=a.selectionEnd+=1}function h(a){var b=a.selectionEnd,c=a.value.lastIndexOf("\n",b),d=a.value.indexOf("\n",b+1);-1!==d&&(b-=c,a.selectionStart=a.selectionEnd=d+b)}function i(a){var b=a.selectionEnd,c=a.value.lastIndexOf("\n",b),d=a.value.lastIndexOf("\n",c-1);-1!==c&&(b-=c,a.selectionStart=a.selectionEnd=d+b)}var j=l||document.activeElement;j&&(13==b?c(j):33==b||34==b||(35==b?e(j):36==b?d(j):37==b?f(j):38==b?i(j):39==b?g(j):40==b&&h(j)))},t=function(a){h=a;var b,c,d;for(b=0;b<k.length;b++)for(d=k[b],c=0;c<d.length;c++)d[c].invalid||(d[c].dom.parentElement.style.display="table-cell");for(b=0;b<k.length;b++)for(d=k[b],c=0;c<d.length;c++)d[c].invalid||d[c].update()},u=function(a){var b=[];try{var c='{"layout": ['+a+"] }",d=JSON.parse(c);if(void 0===d.layout||!r("Array",d.layout))throw'- the JSON object has no "layout" property, or it is not an array';b=d.layout}catch(e){console.log("The definition of layout\n"+a+"\n\nis not valid:\n"+e.message)}return b},v=function(a,b){var c="";return a&&(a.length>b?c=a[b]:a.length>0&&(c=a[0])),c},w=function(a){for(var b=a.split(","),c=[],d=0;d<b.length;d++)c.push(x(b[d]));return c},x=function(a){var b={titles:[],commands:[]};if(r("String",a)){var c,d,e=a.split("|");if(e.length)for(c=0;c<e.length;c++)if(d=e[c]){var f=d.split(":");!f[0]&&f.length>1?(b.titles.push(":"),b.commands.push(f[1]||":")):1==f.length?(b.titles.push(d),b.commands.push(d)):(b.titles.push(f[0]),b.commands.push(f[1]))}else b.titles.push(""),b.commands.push("")}return y(b),b},y=function(a){a.titles=r("Array",a.titles)?a.titles:[],a.commands=r("Array",a.commands)?a.commands:[];var b;if(a.titles.length<a.commands.length)for(b=a.titles.length;b<a.commands.length;b++)a.titles.push(a.commands[b]);else if(a.commands.length<a.titles.length)for(b=a.commands.length;b<a.titles.length;b++)a.commands.push(a.titles[b]);var c="",d="";for(a.titles.length&&(c=a.titles.slice(-1)[0],d=a.commands.slice(-1)[0]),b=a.titles.length;b<Object.keys(i).length;b++)a.titles.push(c),a.commands.push(d);for(b=0;b<a.commands.length;b++){var e=a.commands[b].split(".");e.length>1&&"png"==e[e.length-1].toLowerCase()&&(e.pop(),a.commands[b]=e.join("."))}"undefined"!=typeof a.zoom&&(a.zoom.length||(a.zoom=[a.zoom,a.zoom,a.zoom]))},z=function(){var a=g.insertRow(-1);return a},A=function(a,c){var d=document.createElement("div");d.className=e.className.button,d.classList.add(b.button),d.addEventListener("mousedown",function(a){C(c),a.preventDefault(),a.stopPropagation()},!1);var f=document.createElement("div");d.appendChild(f);var g=a.insertCell(-1);return g.appendChild(d),c?(c.dom=d,c.update=function(){c.indicator&&(clearInterval(c.indicator.timer),c.indicator=null);var a=c?v(c.titles,h):"";d.style.visibility=a.length?"visible":"hidden";var i=c.commands[h],k=i in j;k?d.classList.add(b.indicator):d.classList.remove(b.indicator),f.innerHTML="",f.style.backgroundImage="";var l=a.split(".");l.length>1&&"png"==l[l.length-1].toLowerCase()?f.style.backgroundImage="url('"+e.imageFolder+a+"')":k?c.indicator={timer:setInterval(function(){q(c,f,i)},50),value:null}:f.innerHTML=a;var m=c.zoom?Math.round(c.zoom[h]):1;if(g.colSpan=m>1?m:1,m>1)for(var n=g.nextElementSibling;n&&m>1;)n.style.display="none",n=n.nextElementSibling,m-=1},c.update(),void 0):(d.invalid=!0,void 0)},B=function(a){for(;g.hasChildNodes();)g.removeChild(g.lastChild);k=r("Array",a)?a:u(a);var b,c,d,e,f,h=k.length;for(b=0;h>b;b++)for(d=k[b],r("Array",d)||(d=[d],k[b]=d),c=0;c<d.length;c++)f=d[c],r("String",f)?(e=w(f),d.splice.apply(d,[c,1].concat(e)),c+=e.length-1):r("Object",f)&&y(f);for(b=0;h>b;b++)for(d=z(),e=k[b],c=0;c<e.length;c++)A(d,e[c])},C=function(a){D(a.commands[h],a.titles[h])},D=function(a,b){if(a)if(a in o){var c=b,d=c.split(".");d.length>1&&"png"==d[d.length-1].toLowerCase()&&(d.pop(),c=d.join(".")),o[a](c)}else if(a in i)t(i[a]);else{var e=l||document.activeElement;if(e){var f=e.selectionStart,g=e.value;if(void 0!==f&&void 0!==g){var h=g.substr(0,f),j=g.substr(f);e.value=h+a+j,e.selectionStart=f+a.length,e.selectionEnd=f+a.length}}}},E=function(){g.classList.remove("etud-animated"),g.classList.remove("etud-animated-fadeOutDown"),g.classList.add("etud-animated-fadeInUp"),g.classList.add("etud-animated"),f.show&&f.show(n)},F=function(){g.classList.remove("etud-animated"),g.classList.remove("etud-animated-fadeInUp"),g.classList.add("etud-animated-fadeOutDown"),g.classList.add("etud-animated"),f.hide&&f.hide()};this.reset=function(){t(0)},this.show=function(a){if(l=r("String",a)?document.getElementById(a):a,g.classList.remove("etud-keyboard-invisible"),l){var b="etud-keyboard-stickBottom",c=l.getBoundingClientRect(),d=window.innerHeight-c.bottom<g.offsetHeight,f=c.top<g.offsetHeight,h=l.ownerDocument.documentElement,i=h.clientHeight-(l.offsetTop+l.offsetHeight),j=i>g.offsetHeight,k=l.offsetTop>g.offsetHeight,m=null,n=function(){var a=g.getBoundingClientRect();return c.top+c.height-a.top+20},o=function(){return-(g.offsetHeight-c.top)-20};!d||j?d&&(m=n):!f||k?(b="etud-keyboard-stickTop",f&&(m=o)):(g.classList.add(e.className.container+"-shrinked"),m=n),g.classList.add(b);var p=function(){var a=m?m():0;if(a){var b=10,c=20,d=function(){var e=0>a?Math.max(-b,a):Math.min(b,a);a-=e,window.scrollBy(0,e),a&&setTimeout(d,c)};setTimeout(d,c)}g.removeEventListener("animationend",p,!1),g.removeEventListener("webkitAnimationEnd",p,!1)};g.addEventListener("animationend",p,!1),g.addEventListener("webkitAnimationEnd",p,!1),l.focus()}E()},this.hide=function(){F();var a=function(){g.classList.add("etud-keyboard-invisible"),g.classList.remove("etud-keyboard-shrinked"),g.classList.remove("etud-keyboard-stickTop"),g.removeEventListener("animationend",a,!1),g.removeEventListener("webkitAnimationEnd",a,!1)};g.addEventListener("animationend",a,!1),g.addEventListener("webkitAnimationEnd",a,!1)},this.isVisible=function(){return"none"!==g.style.display},this.getDOM=function(){return g},this.getState=function(){return h},this.getInputElem=function(){return l},this.print=function(a,b){D(a,b)},B(e.layout),document.body.appendChild(g)}function m(b){var c=!1,d=null,e={speed:0,timer:null},f=function(a){a.classList.remove("etud-animation"),a.classList.remove("etud-animated-fadeOutHalf"),a.classList.add(b.className+"-keyOpaque"),a.classList.add("etud-animated-fadeInHalf"),a.classList.add("etud-animated")},g=function(a){a.classList.remove(b.className+"-keyOpaque"),a.classList.remove("etud-animation"),a.classList.remove("etud-animated-fadeInHalf"),a.classList.add("etud-animated-fadeOutHalf"),a.classList.add("etud-animated")},h=function(){if(!this.scroller.timer){var a=this.scroller.speed,b=this.scroller.direction,d=this;this.scroller.timer=setInterval(function(){return c?(a>0?scrollBy(0,a*b):0>a&&scrollBy(0,Math.round(.9*window.innerHeight*b)),void 0):(clearInterval(d.scroller.timer),d.scroller.timer=null,g(d),void 0)},a>0?20:1e3)}},i=function(){f(this)},j=function(){this.scroller.timer&&(clearInterval(this.scroller.timer),this.scroller.timer=null),g(this)},k=function(c,d){for(var e=c.insertRow(-1),f=0;f<b.speeds.length;f+=1){var g=b.speeds[f],k=document.createElement("div");k.className=b.className+"-key";var l=d?"Up":"Down",m="";g>0?m="smooth"+l:0>g&&(m="page"+l),m&&(k.style.backgroundImage="url('"+b.imageFolder+m+".png')"),k.scroller={speed:g,direction:d?-1:1,timer:null},k.addEventListener(a.etudriver.event.selected,h),k.addEventListener(a.etudriver.event.focused,i),k.addEventListener(a.etudriver.event.left,j);var n=e.insertCell(-1);n.appendChild(k)}},l=function(a){var c=document.createElement("table");c.className=b.className,c.classList.add(b.className+(a?"-upper":"-lower")),k(c,a),document.body.appendChild(c)},m=function(a){var b=0,c=0,d=0;return a.xl&&(c+=a.xl,d+=a.yl,b+=1),a.xr&&(c+=a.xr,d+=a.yr,b+=1),b&&(c/=b,d/=b),{x:c,y:d}};if(b.type===a.etudriver.scroller.fixation){l(!0),l(!1)}this.init=function(){c=!0},this.feed=function(a){d||(d=m(a));var f=m(a),g=f.y-d.y;Math.abs(g)>=b.headPose.threshold?(e.speed=(Math.abs(g)-b.headPose.threshold)*(0>g?-1:1)*b.headPose.transformParam,e.timer||(e.timer=setInterval(function(){return c?(e.speed&&scrollBy(0,e.speed),void 0):(clearInterval(e.timer),e.timer=null,void 0)},20))):(e.speed=0,e.timer&&(clearInterval(e.timer),e.timer=null))},this.reset=function(){c=!1,d=null,e.speed=0,e.timer&&(clearInterval(e.timer),e.timer=null)}}a.etudriver={mapping:{none:0,naive:1,expanded:2},selection:{none:0,cumulativeDwell:1,simpleDwell:2,nod:3,customHeadGesture:4},source:{samples:0,fixations:1},event:{focused:"focused",left:"left",selected:"selected"},scroller:{fixation:0,headPose:1},keyboard:{"default":{layout:'["!|!|1,?|?|2,:|:|3,;|;|4,\\u0027|\\u0027|5,\\u0022|\\u0022|6,&|&|7,@|@|8,(|(|9,)|)|0",{"titles":["backspace.png"], "commands":["backspace"]}],\n["q|Q|+,w|W|-:,e|E|*,r|R|\\/,t|T|=,y|Y|%,u|U|$,i|I|#,o|O|(,p|P|)",{"titles":["enter.png"], "commands":["enter"]}],\n["a|A|@,s|S|~,d|D|^,f|F|\\u005C,g|G|_,h|H|&,j|J|[,k|K|],l|L|\\u007B, | |\\u007D",{"titles":["symbols.png","symbols.png","upcase.png"], "commands":["symbols","symbols","upcase"]}],\n["z|Z|,x|X|,c|C|,v|V|,b|B| ,n|N|,m|M|",{"titles":[",","<","<"], "commands":[",","<","<"]},".|>|>",{"titles":["upcase.png","lowcase.png"], "commands":["upcase","lowcase"]},{"titles":["close.png"], "commands":["hide"]}]',callbacks:{},imageFolder:"images/kbd/default/",className:{container:"etud-keyboardDefault",button:"etud-keyboard-buttonDefault"},selection:{type:1},mapping:{}}},settings:{selection:{defaults:{className:"etud-selected",duration:200,audio:"click.wav"},cumulativeDwell:{dwellTime:1e3,showProgress:!0},simpleDwell:{dwellTime:1e3,showProgress:!0},nod:[{matchAll:!0,interval:{min:80,max:120},left:{amplitude:{min:0,max:.005},angle:{min:0,max:0}},right:{amplitude:{min:0,max:.005},angle:{min:0,max:0}}},{matchAll:!1,interval:{min:100,max:200},left:{amplitude:{min:.015,max:.04},angle:{min:70,max:110}},right:{amplitude:{min:.015,max:.04},angle:{min:70,max:110}}},{matchAll:!1,interval:{min:100,max:200},left:{amplitude:{min:.015,max:.04},angle:{min:250,max:290}},right:{amplitude:{min:.015,max:.04},angle:{min:250,max:290}}},{matchAll:!0,interval:{min:80,max:120},left:{amplitude:{min:0,max:.005},angle:{min:0,max:0}},right:{amplitude:{min:0,max:.005},angle:{min:0,max:0}}}]},mapping:{defaults:{className:"etud-focused"},expanded:{expansion:50}}}};var n={panel:{show:!0,displaySamples:!1,id:"etud-panel",connectedClassName:"etud-panel-connected"},targets:[{selector:".etud-target",keyboard:null,selection:{type:a.etudriver.selection.cumulativeDwell},mapping:{}}],mapping:{type:a.etudriver.mapping.naive,source:a.etudriver.source.samples},pointer:{show:!0,size:8,color:"MediumSeaGreen",opacity:.5,smoothing:{enabled:!0,low:300,high:10,timeWindow:50,threshold:25}},progress:{color:"Teal",opacity:.5,size:60,minWidth:5,delay:200},fixdet:{maxFixSize:50,bufferLength:10},headCorrector:{enabled:!0,transformParam:500},headGesture:{timeWindow:800},customHeadGestureDetector:{calibration:{trials:5,threshold:.012,trialDuration:2e3,pauseDuration:2e3,plotSizeFactor:1},detection:{maxAmplitudeError:.2,minCorrelation:.85,minPause:500,alterRefSignalOnDetection:!1}},css:{file:"etudriver",useVersion:!0},scroller:{enabled:!1,speeds:[2,7,15,-1],type:a.etudriver.scroller.headPose,className:"etud-scroller",imageFolder:"images/scroller/",size:80,delay:800,headPose:{threshold:.005,transformParam:500}},port:8086,frequency:0},o={state:null,sample:null,target:null,keyboard:null};a.etudriver.init=function(b,e){var g=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("link");c.rel="stylesheet",c.type="text/css",c.href=a,c.media="all",b.appendChild(c)},h=function(){var a=function(){return-1!==navigator.userAgent.indexOf("MSIE")},b='\n            <span id="etud-device"></span>\n            <input id="etud-showOptions" type="button" value="Options" disabled />\n            <input id="etud-calibrate" type="button" value="Calibrate" disabled />\n            <input id="etud-toggleTracking" type="button" value="Start" disabled />\n            <span id="etud-chgd-calibMenu"><ul><li><a href="#">Calibrate gesture</a><ul id="etud-chgd-calibList"></ul></li></ul></span>\n            <span id="etud-log"></span>\n            ';I=document.createElement("div"),I.id=n.panel.id,I.innerHTML=b;var c=window.getComputedStyle(document.body).paddingTop;document.body.insertBefore(I,document.body.firstChild),document.body.style.margin="0px",a()||setTimeout(function(){document.body.style.paddingTop=Math.max(parseInt(c,10),I.scrollHeight)+"px"},100),J=document.getElementById("etud-device"),K=document.getElementById("etud-showOptions"),L=document.getElementById("etud-calibrate"),M=document.getElementById("etud-toggleTracking"),N=document.getElementById("etud-log"),K.addEventListener("click",function(){db(p.showOptions)}),L.addEventListener("click",function(){db(p.calibrate)}),M.addEventListener("click",function(){db(p.toggleTracking)})},i=function(b){if(I){var c=document.getElementById("etud-chgd-calibList");for(var d in b)if(!T[d]){T[d]=new k(d);var e=document.createElement("li"),f=document.createElement("input");f.type="button",f.value=d.charAt(0).toUpperCase()+d.slice(1);var g=function(b,c){b.addEventListener("click",function(){a.etudriver.calibrateCustomHeadGesture(c,function(a){})})};g(f,d),e.appendChild(f),c.appendChild(e)}c.hasChildNodes()&&(document.getElementById("etud-chgd-calibMenu").style.display="inline")}},j=function(){O=document.createElement("div"),O.className="etud-pointer";var a=O.style;a.display="none",a.backgroundColor=n.pointer.color,a.opacity=n.pointer.opacity,a.borderRadius=(n.pointer.size/2).toFixed(0)+"px",a.height=n.pointer.size+"px",a.width=n.pointer.size+"px",document.body.appendChild(O)},q=yb();X=q!==!1?q.path:"",zb(!0,n,b),zb(!0,o,e);var r=!1,s=!1,t={},u=function(b){switch(b.selection=zb(!0,{},a.etudriver.settings.selection.defaults,b.selection),b.mapping=zb(!0,{},a.etudriver.settings.mapping.defaults,b.mapping),b.selection.type){case a.etudriver.selection.cumulativeDwell:zb(!0,!0,b.selection,a.etudriver.settings.selection.cumulativeDwell);break;case a.etudriver.selection.simpleDwell:zb(!0,!0,b.selection,a.etudriver.settings.selection.simpleDwell);break;case a.etudriver.selection.nod:zb(!0,!0,b.selection,a.etudriver.settings.selection.nod)}if(void 0!==b.selection.dwellTime&&(r=!0),b.selection.type===a.etudriver.selection.nod&&(s=!0),b.selection.type===a.etudriver.selection.customHeadGesture){var c=b.selection.name||"default";t[c]=!0}b.selection.audio&&(b.selection.audio=new Audio(X+b.selection.audio))};for(var v in n.targets){var w=n.targets[v];u(w)}for(var y in a.etudriver.keyboard){var z=a.etudriver.keyboard[y];z.selection&&z.selection.type||(z.selection={type:a.etudriver.selection.cumulativeDwell}),u(z),z.name=y,U[y]=new l(z,x,{hide:function(){o.keyboard&&o.keyboard(V,!1),V=null,a.etudriver.updateTargets()},show:function(b){V=b,o.keyboard&&o.keyboard(V,!0),a.etudriver.updateTargets()}})}switch(n.mapping.type){case a.etudriver.mapping.expanded:zb(!0,!0,n.mapping,a.etudriver.settings.mapping.expanded)}if(n.css.file){var A=X+n.css.file;n.css.useVersion&&q.version&&(A+="-"+q.version),A+=".css",g(A)}n.panel.show&&h(),j(),r&&(P=document.createElement("canvas"),P.className="etud-progress",P.height=n.progress.size,P.width=n.progress.size,P.style.display="none",document.body.appendChild(P)),Q=new c;var B={type:a.etudriver.selection.cumulativeDwell,className:"",duration:0,audio:"",dwellTime:800,showProgress:!1};n.scroller.targets={smooth:{selector:"."+n.scroller.className+"-smooth",selection:n.scroller.type===a.etudriver.scroller.fixation?B:{type:a.etudriver.selection.none},mapping:{className:""}},page:{selector:"."+n.scroller.className+"-page",selection:n.scroller.type===a.etudriver.scroller.fixation?B:{type:a.etudriver.selection.none},mapping:{className:""}}};for(var C in n.scroller.targets){var w=n.scroller.targets[C];u(w)}W=new m(n.scroller),n.pointer.smoothing.enabled&&(R=new d),s&&(S=new f(a.etudriver.settings.selection.nod)),i(t),a.etudriver.updateTargets(),cb(n.port)},a.etudriver.updateTargets=function(){u=[];var a,b,c,d=function(a,b){a.gaze={focused:!1,selected:!1,attention:0,selection:b.selection,mapping:b.mapping,keyboard:b.keyboard?U[b.keyboard]:null},u.push(a)};for(var e in n.targets)for(a=n.targets[e],b=document.querySelectorAll(a.selector),c=0;c<b.length;c+=1)d(b[c],a);if(V)for(a=V.options,b=V.getDOM().querySelectorAll("."+x.button),c=0;c<b.length;c+=1)d(b[c],a);for(var f in n.scroller.targets)for(a=n.scroller.targets[f],b=document.querySelectorAll(a.selector),c=0;c<b.length;c+=1)d(b[c],a)},a.etudriver.calibrateCustomHeadGesture=function(a,b){var c=T[a];return c?(c.init(c.modes.calibration,function(c){"finished"===c&&b&&b(a)}),!0):!1},a.etudriver.showOptions=function(){db(p.showOptions)},a.etudriver.calibrate=function(){db(p.calibrate)},a.etudriver.toggleTracking=function(){db(p.toggleTracking)},a.etudriver.getKeyboard=function(a){return U[a]};var p={showOptions:"SHOW_OPTIONS",calibrate:"CALIBRATE",toggleTracking:"TOGGLE_TRACKING",setDevice:"SET_DEVICE"},q={sample:"sample",state:"state",device:"device"},r={none:0,connected:1,calibrated:2,tracking:4,busy:8},s={disconnected:"DISCONNECTED",connecting:"CONNECTING...",connected:"CONNECTED"},t={device:"etudriver-device"},u=[],v={x:1,y:1},w={x:0,y:0},x={button:"etud-keyboard-keyMarker",indicator:"etud-keyboard-indicator"},y=0,z=null,A=null,B=null,C=null,D=r.none,E="",F=[],G=0,H=0,I=null,J=null,K=null,L=null,M=null,N=null,O=null,P=null,Q=null,R=null,S=null,T={},U={},V=null,W=null,X="",Y=null,Z="Mouse",$=function(){if(I){eb(s.connected),I.classList.add(n.panel.connectedClassName);var a=rb(r.none);qb(a),xb()&&(Z=localStorage[t.device]||Z),Z&&db(p.setDevice+" "+Z)}},_=function(){if(Y=null,I){E="",eb(s.disconnected),I.classList.remove(n.panel.connectedClassName);var a=rb(r.none);qb(a)}},ab=function(a){try{var b,c=JSON.parse(a.data);c.type===q.sample?y?F.push({ts:c.ts,x:c.x,y:c.y,pupil:c.p,ec:c.ec}):gb(c.ts,c.x,c.y,c.p,c.ec):c.type===q.state?(vb("onWebSocketMessage","WebSocket got state: "+a.data),b=rb(c.value),fb(b)):c.type===q.device&&(vb("onWebSocketMessage","WebSocket got device: "+a.data),Z=c.name,xb()&&(localStorage[t.device]=Z),b=rb(void 0,c.name),fb(b))}catch(d){wb("onWebSocketMessage",d),wb("onWebSocketMessage",a.data)}},bb=function(a){vb("onWebSocketError",a),N&&(N.innerHTML="Problems in the connection to WebSocket server",setTimeout(function(){N.innerHTML=""},5e3))},cb=function(a){eb(s.connecting);var b="ws://localhost:"+a+"/";Y=new WebSocket(b),Y.onopen=$,Y.onclose=_,Y.onmessage=ab,Y.onerror=bb},db=function(a){vb("sendToWebSocket","WebSocket sent: "+a),Y.send(a)},eb=function(a){J&&(J.innerHTML=a)},fb=function(b){sb(),I&&qb(b),Ab(n.pointer.show)&&(O.style.display=b.isTracking?"block":"none"),P&&(P.style.display=b.isTracking?"block":"none"),"function"==typeof o.state&&o.state(b);var c,d;if(b.isTracking){n.frequency>=10&&n.frequency<=100&&(y=setTimeout(ub,1e3/n.frequency),H=(new Date).getTime(),G=0),R&&R.init(),W&&W.init(),z=null,A=null,B=null,C=null,a.etudriver.updateTargets(),Bb.reset();
for(c in T)d=T[c],d.init(d.modes.detection)}else{for(c in T)d=T[c],d.finilize();y&&(clearTimeout(y),y=0);var e;for(e=0;e<u.length;e+=1){var f=u[e];f.gaze.focused=!1,f.gaze.selected=!1,f.gaze.mapping.className&&f.classList.remove(f.gaze.mapping.className)}V&&V.hide(),b.isStopped&&W&&W.reset()}},gb=function(b,c,d,e,f){var g=tb(c,d);if(Ab(n.headCorrector.enabled)&&f&&(C||Q.init(f),g=Q.correct(g,f)),"function"==typeof o.sample&&o.sample(b,g.x,g.y,e,f),I&&n.panel.displaySamples){var h=function(a,b){for(var c=a+",";c.length<b;)c+=" ";return c},i="t = "+h(b,6)+" x = "+h(g.x,5)+" y = "+h(g.y,5)+" p = "+h(e,4);if(void 0!==f){i+="ec: { ";var j;for(j in f)i+=j+" = "+f[j]+", ";i+="}"}N.innerHTML=i}if(Bb.feed(b,g.x,g.y),ib(n.mapping.type,g.x,g.y),f){var k;S&&(k=z&&z.gaze.selection.type===a.etudriver.selection.nod,S.feed(b,g.x,g.y,e,f,k?z:null));for(var l in T){var m=T[l];k=z&&z.gaze.selection.type===a.etudriver.selection.customHeadGesture&&z.gaze.selection.name===m.getName(),m.feed(b,f,k?z:null)}n.scroller.type===a.etudriver.scroller.headPose&&W.feed(f)}if(lb(b,g.x,g.y,e,f),A&&pb(Ab(A.gaze.selection.showProgress)?A:null),Ab(n.pointer.show)){"block"!==O.style.display&&(O.style.display="block");var p={x:0,y:0};n.mapping.source==a.etudriver.source.samples?(p.x=g.x,p.y=g.y):n.mapping.source==a.etudriver.source.fixations&&Bb.currentFix&&(p.x=Bb.currentFix.x,p.y=Bb.currentFix.y),R&&(p=R.smooth(b,p.x,p.y)),O.style.left=p.x-n.pointer.size/2+"px",O.style.top=p.y-n.pointer.size/2+"px"}else"none"!==O.style.display&&(O.style.display="none");C={ts:b,x:c,y:d,pupil:e,ec:f}},hb=function(a){var b=!!V&&!a.classList.contains(x.button)||"hidden"===a.style.visibility||a.classList.contains(x.indicator);return b},ib=function(b,c,d){var e=a.etudriver.mapping,f=a.etudriver.source,g=null;switch(n.mapping.source==f.fixations&&Bb.currentFix&&(c=Bb.currentFix.x,d=Bb.currentFix.y),b){case e.naive:g=jb(c,d);break;case e.expanded:g=kb(c,d)}if(g!==z){var h;z&&(z.gaze.focused=!1,z.gaze.mapping.className&&z.classList.remove(z.gaze.mapping.className),h=new Event(a.etudriver.event.left),z.dispatchEvent(h),"function"==typeof o.target&&o.target(a.etudriver.event.left,z)),g&&(g.gaze.focused=!0,g.gaze.mapping.className&&g.classList.add(g.gaze.mapping.className),h=new Event(a.etudriver.event.focused),g.dispatchEvent(h),"function"==typeof o.target&&o.target(a.etudriver.event.focused,g),ob(g)),z=g,z&&(A=z)}},jb=function(a,b){var c,d=null;for(c=0;c<u.length;c+=1){var e=u[c];if(!hb(e)){var f=e.getBoundingClientRect();if(a>=f.left&&a<f.right&&b>=f.top&&b<f.bottom)if(d){if(document.elementFromPoint(a,b)===e){d=e;break}}else d=e}}return d},kb=function(a,b){var c,d=null,e=Number.MAX_VALUE;for(c=0;c<u.length;c+=1){var f=u[c];if(!hb(f)){var g=f.getBoundingClientRect(),h=a<g.left?g.left-a:a>g.right?a-g.right:0,i=b<g.top?g.top-b:b>g.bottom?b-g.bottom:0,j=Math.sqrt(h*h+i*i);if(e>j&&j<n.mapping.expansion)d=f,e=j;else if(0===j&&document.elementFromPoint(a,b)===f){d=f;break}}}return d},lb=function(b){var c,d=a.etudriver.selection,e=null;for(c=0;c<u.length;c+=1){var f=u[c];if(!hb(f)){switch(f.gaze.selection.type){case d.cumulativeDwell:C&&mb(f,b-C.ts)&&(e=f);break;case d.simpleDwell:Bb.currentFix&&C&&nb(f,b-C.ts)&&(e=f);break;case d.nod:e=S.current;break;case d.customHeadGesture:for(var g in T){var h=T[g];e=h.current||e}}if(e)break}}if(e!==B){if(B&&(B.gaze.selected=!1),e){e.gaze.selected=!0,e.gaze.selection.className&&(e.classList.add(e.gaze.selection.className),setTimeout(function(){e.classList.remove(e.gaze.selection.className)},e.gaze.selection.duration)),e.gaze.selection.audio&&e.gaze.selection.audio.play();var i=new Event(a.etudriver.event.selected);e.dispatchEvent(i),"function"==typeof o.target&&o.target(a.etudriver.event.selected,e),e.gaze.keyboard&&e.gaze.keyboard.show(e)}B=e}},mb=function(b,c){var d,e=!1;if(b===z){if(b.gaze.attention+=c,b.gaze.attention>=b.gaze.selection.dwellTime)for(e=!0,d=0;d<u.length;d+=1){var f=u[d];f.gaze.selection.type===a.etudriver.selection.cumulativeDwell&&(f.gaze.attention=0)}}else b.gaze.attention=Math.max(0,b.gaze.attention-c);return e},nb=function(b,c){var d=!1;if(b===z){b.gaze.attention+=c;for(var e=0;e<u.length;e+=1){var f=u[e];f.gaze.selection.type===a.etudriver.selection.simpleDwell&&f!==b&&(f.gaze.attention=0)}b.gaze.attention>=b.gaze.selection.dwellTime&&(d=!0,b.gaze.attention=0)}else b.gaze.attention=0;return d},ob=function(a){if(P&&"undefined"!=typeof a.gaze.selection.dwellTime){var b=a.getBoundingClientRect();P.style.left=Math.round(b.left+(b.width-n.progress.size)/2)+"px",P.style.top=Math.round(b.top+(b.height-n.progress.size)/2)+"px"}},pb=function(a){if(P){var b=P.getContext("2d"),c=n.progress.size;if(b.clearRect(0,0,c,c),a){var d=Math.min(1,(a.gaze.attention-n.progress.delay)/(a.gaze.selection.dwellTime-n.progress.delay));d>0&&(b.beginPath(),b.lineWidth=Math.max(n.progress.minWidth,c/10),b.arc(c/2,c/2,.45*c,-.5*Math.PI,-.5*Math.PI+2*Math.PI*d),b.strokeStyle=n.progress.color,b.stroke())}}},qb=function(a){a.device&&(J.innerHTML=a.device),K.disabled=!Y||a.isTracking||a.isBusy,L.disabled=!a.isConnected||a.isTracking||a.isBusy,M.disabled=!a.isCalibrated||a.isBusy,M.value=a.isTracking?"Stop":"Start",!a.isTracking&&a.isCalibrated&&(N.innerHTML="")},rb=function(a,b){var c=!1;return void 0!==a?(c=(D&r.tracking)>0&&0===(a&r.tracking),D=a):a=D,void 0!==b?E=b:b=E,{isServiceRunning:!!Y,isConnected:(D&r.connected)>0,isCalibrated:(D&r.calibrated)>0,isTracking:(D&r.tracking)>0,isBusy:(D&r.busy)>0,isStopped:c,device:E}},sb=function(){if(void 0!==window.mozInnerScreenX){var a=function(a){var b,c,d=0,e=function(a,b,c){for(var e=window.matchMedia;a>=b&&!e("(min-resolution: "+a/c+"dppx)").matches;)a-=1,d+=1;return a},f=5,g=.1,h=1;for(c=0;a>c;c+=1)b=10*e(f,g,h),f=b+9,g=b,h*=10;return b/h}(5);v={x:a,y:a},w={x:window.mozInnerScreenX*a,y:window.mozInnerScreenY*a}}else{v={x:devicePixelRatio,y:devicePixelRatio};var b=window.innerWidth*v.x,c=window.innerHeight*v.y;w={x:window.screenX+(window.outerWidth-b)/2,y:window.screenY+(window.outerHeight-c)-(window.outerWidth-b)/2}}},tb=function(a,b){return{x:(a-w.x)/v.x,y:(b-w.y)/v.y}},ub=function(){G+=1;var a=null;if(F.length){for(var b=0,c=0,d=0,e={xl:0,yl:0,xr:0,yr:0},f=0;f<F.length;f+=1){var g=F[f];b+=g.x,c+=g.y,d+=g.pupil,g.ec&&(e.xl+=g.ec.xl,e.yl+=g.ec.yl,e.xr+=g.ec.xr,e.yr+=g.ec.yr)}a={ts:Math.round(G*(1e3/n.frequency)),x:b/F.length,y:c/F.length,pupil:d/F.length,ec:{xl:e.xl/F.length,yl:e.yl/F.length,xr:e.xr/F.length,yr:e.yr/F.length}},F=[]}else C&&(a=C);a&&gb(a.ts,a.x,a.y,a.pupil,a.ec);var h=(new Date).getTime(),i=Math.round(H+(G+1)*(1e3/n.frequency)),j=Math.max(0,i-h);y=setTimeout(ub,j)},vb=function(a,b){console.log(a+": "+b)},wb=function(a,b){console.error(a+": "+b)},xb=function(){var a=!0;try{a=!!localStorage}catch(b){a=!1}return a},yb=function(){var a,b=function(a){function c(a){for(var b="";a;)if("../"===a.substr(0,3)||"./"===a.substr(0,2))a=a.replace(/^\.+/,"").substr(1);else if("/./"===a.substr(0,3)||"/."===a)a="/"+a.substr(3);else if("/../"===a.substr(0,4)||"/.."===a)a="/"+a.substr(4),b=b.replace(/\/?[^\/]*$/,"");else if("."===a||".."===a)a="";else{var c=a.match(/^\/?[^\/]*/)[0];a=a.substr(c.length),b+=c}return b}this.scheme=null,this.authority=null,this.path="",this.query=null,this.fragment=null,this.parse=function(a){var b=a.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);return this.scheme=b[3]?b[2]:null,this.authority=b[5]?b[6]:null,this.path=b[7],this.query=b[9]?b[10]:null,this.fragment=b[12]?b[13]:null,this},this.toString=function(){var a="";return null!==this.scheme&&(a=a+this.scheme+":"),null!==this.authority&&(a=a+"//"+this.authority),null!==this.path&&(a+=this.path),null!==this.query&&(a=a+"?"+this.query),null!==this.fragment&&(a=a+"#"+this.fragment),a},this.toAbsolute=function(a){a=new b(a);var d=this,e=new b;return null===a.scheme?!1:(null!==d.scheme&&d.scheme.toLowerCase()===a.scheme.toLowerCase()&&(d.scheme=null),null!==d.scheme?(e.scheme=d.scheme,e.authority=d.authority,e.path=c(d.path),e.query=d.query):(null!==d.authority?(e.authority=d.authority,e.path=c(d.path),e.query=d.query):(""===d.path?(e.path=a.path,e.query=null!==d.query?d.query:a.query):("/"===d.path.substr(0,1)?e.path=c(d.path):(e.path=null!==a.authority&&""===a.path?"/"+d.path:a.path.replace(/[^\/]+$/,"")+d.path,e.path=c(e.path)),e.query=d.query),e.authority=a.authority),e.scheme=a.scheme),e.fragment=d.fragment,e)},a&&this.parse(a)},c=location.href,d=document.getElementsByTagName("base");for(a=0;a<d.length;a+=1)d[a].href&&(c=d[a].href);var e=/(^|\/)etudriver(-(\d+)\.(\d+)\.(\d+))?\.js([?#].*)?$/i;for(d=document.getElementsByTagName("script"),a=0;a<d.length;a+=1)if(d[a].src){var f=e.exec(d[a].src);if(f){var g=new b(d[a].src),h=g.toAbsolute(c);return h.path=h.path.replace(/[^\/]+$/,""),h.query=null,h.fragment=null,{path:h.toString(),version:"undefined"!=typeof f[2]?f[3]+"."+f[4]+"."+f[5]:""}}}return!1},zb=function(){var a,b,c,d,e,f,g=function(a){return"object"!=typeof a||a.nodeType||a===a.window?!1:!0},h=arguments[0]||{},i=1,j=arguments.length,k=!1,l=!1;if("boolean"==typeof h&&(k=h,h=arguments[i]||{},i+=1),"boolean"==typeof h&&(l=h,h=arguments[i]||{},i+=1),"object"!=typeof h&&"function"!=typeof h&&(h={}),j===i)return h;for(;j>i;i+=1)if(null!=(a=arguments[i]))for(b in a)c=h[b],d=a[b],h!==d&&(k&&d&&(g(d)||(e=Array.isArray(d)))?(e?(e=!1,f=c&&Array.isArray(c)?c:[]):f=c&&g(c)?c:{},h[b]=zb(k,f,d)):void 0!==d&&(l&&void 0!==h[b]||(h[b]=d)));return h},Ab=function(a){return"function"==typeof a?a():!!a};b.prototype.addSample=function(a,b,c){this.samples.length==n.fixdet.bufferLength&&this.samples.shift(),this.samples.push({x:b,y:c}),this.duration=a-this.ts;for(var d=0,e=0,f=0;f<this.samples.length;f+=1){var g=this.samples[f];d+=g.x,e+=g.y}this.x=d/this.samples.length,this.y=e/this.samples.length};var Bb={currentFix:null,candidateFix:null,feed:function(a,c,d){var e=!1;if(this.currentFix)if(this.candidateFix){var f=this.currentFix.x-c,g=this.currentFix.y-d,h=Math.sqrt(f*f+g*g),i=this.candidateFix.x-c,j=this.candidateFix.y-d,k=Math.sqrt(i*i+j*j);h<n.fixdet.maxFixSize?this.currentFix.addSample(a,c,d):k<n.fixdet.maxFixSize?(this.currentFix=this.candidateFix,this.candidateFix=null,this.currentFix.addSample(a,c,d),e=!0):(this.candidateFix=new b(a,c,d),this.candidateFix.saccade.dx=c-this.currentFix.x,this.candidateFix.saccade.dy=d-this.currentFix.y)}else{var l=this.currentFix.x-c,m=this.currentFix.y-d,o=Math.sqrt(l*l+m*m);o<n.fixdet.maxFixSize?this.currentFix.addSample(a,c,d):(this.candidateFix=new b(a,c,d),this.candidateFix.saccade.dx=c-this.currentFix.x,this.candidateFix.saccade.dy=d-this.currentFix.y)}else this.currentFix=new b(a,c,d),e=!0;return e},reset:function(){this.currentFix=null,this.candidateFix=null}};e.prototype.isMatched=function(a){var b=1<<a;return(this.matched&b)>0},e.prototype.setMatched=function(a,b){var c=~(1<<a);this.matched=(this.matched&c)+(b?1<<a:0)},f.prototype.init=function(){this.buffer=[],this.eventIsOn=!1,this.canTest=!1,this.current=null},f.prototype.feed=function(a,b,c,d,f){var g=null;if(d){for(var h=0;h<this.buffer.length&&a-this.buffer[h].ts>n.headGesture.timeWindow;h++)this.buffer.shift(),this.canTest=!0;this.canTest=this.canTest&&this.buffer.length>0;var i=new e(a,b,c,d,f);this.canTest&&this.test(i),this.buffer.push(i),this.canTest&&(g=this.searchPattern())}return this.current=g?g.object:null,g},f.prototype.isRangeTestable=function(a){return 0!==a.min||0!==a.max},f.prototype.normalizeAngles=function(a,b){var c=a.min,d=a.max;return 0===c&&0===d?d=360:c>d&&(180>b?c=0:d=360),{min:c,max:d}},f.prototype.testRule=function(a,b,c,d){var e=!1,f=this.normalizeAngles(a[b].angle,d),g=a[b].amplitude;return e=c>=g.min&&c<=g.max&&d>=f.min&&d<=f.max},f.prototype.test=function(a){var b;for(b=0;b<this.rules.length;b+=1){for(var c=this.rules[b],d=this.buffer.length-1,e=a.ts-c.interval.max,f=a.ts-c.interval.min;d>=0&&this.buffer[d].ts>f;)d-=1;for(var g=c.matchAll;d>=0&&this.buffer[d].ts>e;){var h=this.buffer[d];d-=1;var i=a.ec.xl-h.ec.xl,j=a.ec.yl-h.ec.yl,k=a.ec.xr-h.ec.xr,l=a.ec.yr-h.ec.yr,m=Math.sqrt(i*i+j*j),n=180*Math.atan2(j,i)/Math.PI,o=Math.sqrt(k*k+l*l),p=180*Math.atan2(l,k)/Math.PI;0>n&&(n+=360),0>p&&(p+=360);var q=(this.isRangeTestable(c.left.amplitude)?this.testRule(c,"left",m,n):!0)&&(this.isRangeTestable(c.right.amplitude)?this.testRule(c,"right",o,p):!0);if(c.matchAll){if(g=g&&q,!q)break}else if(g=g||q,q)break}a.setMatched(b,g)}},f.prototype.searchPattern=function(){var a,b=null,c=this.rules.length-1,d=-1,e=0,f=null,g=null;for(a=this.buffer.length-1;a>=0;a-=1){var h=this.buffer[a];if(h.isMatched(c)){if(e>0&&e-h.ts>this.rules[d].interval.max)break;if(c===this.rules.length-1)g=h;else if(0===c){for(var i=h.ts-this.rules[0].interval.max;a>0&&this.buffer[a-1].ts>i;)a-=1;f=this.buffer[a];break}e=h.ts,d=c,c-=1}else d>=0&&h.isMatched(d)&&(e=h.ts)}var j=0,k=0;for(a=0;a<this.rules.length;a+=1){var l=this.rules[a];j+=l.interval.max,k+=l.interval.min}var m=f&&g&&g.ts-f.ts<j&&g.ts-f.ts>k?!0:!1;if(m&&!this.eventIsOn)for(b={object:f.focused};this.buffer.length>0;){var n=this.buffer[0];if(!(n.ts<g.ts))break;this.buffer.shift()}return this.eventIsOn=m,b},f.prototype.computeEyeGazePoints=function(a){for(var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=Math.max(a,9),l=this.buffer[k].ts,m=l;150>l-m&&k>=0;){var n=this.buffer[k];b+=n.x,c+=n.y,d+=1,n.ec.xl>0&&(e+=n.ec.xl,f+=n.ec.yl,g+=1),n.ec.xr>0&&(h+=n.ec.xr,i+=n.ec.yr,j+=1),m=n.ts,k-=1}return d>0&&(b/=d,c/=d),g>0&&(e/=g,f/=g),j>0&&(h/=j,i/=j),{gaze:{x:b,y:c},eye:{left:{x:e,y:f},right:{x:h,y:i}}}},g.prototype.isSet=function(){return!(0===this.ec.xl&&0===this.ec.yl&&0===this.ec.xr&&0===this.ec.yr)},g.prototype.isValid=function(){return-1!==this.timestamp}}(window);