/*! etudriver 21-01-2014 */
!function(a){"use strict";function b(){}function c(a,b,c){this.ts=a,this.x=b,this.y=c,this.duration=0,this.saccade={dx:0,dy:0},this.samples=[]}function d(a){this.currentFix=null;var b=null;this.feed=function(d,e,f){var g=!1;if(this.currentFix)if(b){var h=this.currentFix.x-e,i=this.currentFix.y-f,j=Math.sqrt(h*h+i*i),k=b.x-e,l=b.y-f,m=Math.sqrt(k*k+l*l);j<a.maxFixSize?this.currentFix.addSample(a.bufferLength,d,e,f):m<a.maxFixSize?(this.currentFix=b,b=null,this.currentFix.addSample(a.bufferLength,d,e,f),g=!0):(b=new c(d,e,f),b.saccade.dx=e-this.currentFix.x,b.saccade.dy=f-this.currentFix.y)}else{var n=this.currentFix.x-e,o=this.currentFix.y-f,p=Math.sqrt(n*n+o*o);p<a.maxFixSize?this.currentFix.addSample(a.bufferLength,d,e,f):(b=new c(d,e,f),b.saccade.dx=e-this.currentFix.x,b.saccade.dy=f-this.currentFix.y)}else this.currentFix=new c(d,e,f),g=!0;return g},this.reset=function(){this.currentFix=null,b=null}}function e(a){var b=null,c=function(a){var b=0,c=0,d=0;return a.xl&&(c+=a.xl,d+=a.yl,b+=1),a.xr&&(c+=a.xr,d+=a.yr,b+=1),b&&(c/=b,d/=b),{x:c,y:d}};this.init=function(a){b=c(a)},this.correct=function(d,e){var f=c(e),g=(f.x-b.x)*a.transformParam,h=(f.y-b.y)*a.transformParam;return{x:Math.round(d.x-g),y:Math.round(d.y+h)}}}function f(a){this.x=-1,this.y=-1,this.t=0,this.interval=0,this.buffer=[],this.init=function(){this.x=-1,this.y=-1,this.t=0,this.buffer=[]},this.smooth=function(b,c,d){this.x<0&&this.y<0&&0===this.t&&(this.x=c,this.y=d,this.t=a.low);var e,f=0,g=0,h=0,i=0,j=0,k=0,l=!1;for(this.buffer.push({ts:b,x:c,y:d}),e=0;e<this.buffer.length;e+=1){var m=this.buffer[e],n=b-m.ts;n>2*a.timeWindow?(this.buffer.shift(),l=!0):n>a.timeWindow?(f+=m.x,g+=m.y,j++):(h+=m.x,i+=m.y,k++)}if(j&&k){f/=j,g/=j,h/=k,i/=k;var o=f-h,p=g-i,q=Math.sqrt(o*o+p*p);this.t=q>a.threshold?a.high:a.low}if(l&&!this.interval&&this.buffer.length>1){var r=0;for(e=1;e<this.buffer.length;e+=1)r+=this.buffer[e].ts-this.buffer[e-1].ts;this.interval=r/(this.buffer.length-1)}if(this.interval){var s=this.t/this.interval;this.x=(c+s*this.x)/(1+s),this.y=(d+s*this.y)/(1+s)}return{x:this.x,y:this.y}}}function g(a,b,c,d,e){this.matched=0,this.ts=a,this.x=b,this.y=c,this.ec=d,this.focused=e}function h(a,b){this.settings=b,this.rules=a,this.buffer=[],this.eventIsOn=!1,this.canTest=!1,this.current=null}function i(a,b,c){this.ec=b||{xl:0,yl:0,xr:0,yr:0},this.timestamp=a||-1,this.focused=c||null}function j(a,b,c,d){this.xl=a||0,this.yl=b||0,this.xr=c||0,this.yr=d||0}function k(a,b){this.left=a||0,this.right=b||0}function l(a,b){var c=b,d=null,e=.3,f=.8,g=2e3,h=[],i=[],l=null,m=0,n=!1,o=!0,p=null,q=0,r=0,s=null,t=new j,u=a.calibration.trials,v=document.createElement("div");v.id="etud-chgd-calibOverlay",v.innerHTML='        <div id="etud-chgd-calib">            <a id="etud-chgd-calibClose" href="#">X</button>        </div>',document.body.insertBefore(v,document.body.firstChild);var w=this;document.getElementById("etud-chgd-calibClose").addEventListener("click",function(){return w.hide(!0),!1});var x=document.createElement("canvas");x.id="etud-chgd-calibCanvas",x.width=Math.round(320*a.calibration.plotSizeFactor),x.height=Math.round(240*a.calibration.plotSizeFactor),document.getElementById("etud-chgd-calib").appendChild(x);var y=x.getContext("2d"),z=function(b,c,d,e,f){for(var g=-1,h=a.calibration.threshold,i=b[c],j=d;f>0?e>j:j>=e;j+=f){var k=b[j],l=k.ec.xl-i.ec.xl,m=k.ec.yl-i.ec.yl,n=k.ec.xr-i.ec.xr,o=k.ec.yr-i.ec.yr,p=Math.sqrt(l*l+m*m),q=Math.sqrt(n*n+o*o);if(p>h||q>h){g=j;break}}return g},A=function(){return Math.max(5,q-Math.max(2*r,.2*q))},B=function(){return Math.max(10,q+Math.max(2*r,.2*q))},C=function(a,b,c){var d=new j;if(c>b){for(var e=b;c>=e;e+=1){var f=a[e];d.xl+=f.ec.xl,d.yl+=f.ec.yl,d.xr+=f.ec.xr,d.yr+=f.ec.yr}var g=c-b+1;d.xl/=g,d.yl/=g,d.xr/=g,d.yr/=g}return d},D=function(a,b,c,d){if(c>b)for(var e=b;c>=e;e+=1){var f=a[e];f.ec.xl-=d.xl,f.ec.yl-=d.yl,f.ec.xr-=d.xr,f.ec.yr-=d.yr}},E=function(a,b,c,d){var e={error:new k,correl:new k};if(c>b){for(var f=new k,g=new k,h=new k,i=new k,l=new k,m=b;c>=m;m+=1){var n=Math.round((m-b)/(c-b)*(s.length-1)),o=s[n],p=a[m],q=new j(p.ec.xl-d.xl,p.ec.yl-d.yl,p.ec.xr-d.xr,p.ec.yr-d.yr);e.error.left+=Math.sqrt(Math.pow(q.xl-o.xl,2)+Math.pow(q.yl-o.yl,2)),e.error.right+=Math.sqrt(Math.pow(q.xr-o.xr,2)+Math.pow(q.yr-o.yr,2));var r=new k(Math.sqrt(Math.pow(q.xl,2)+Math.pow(q.yl,2)),Math.sqrt(Math.pow(q.xr,2)+Math.pow(q.yr,2))),u=new k(Math.sqrt(Math.pow(o.xl,2)+Math.pow(o.yl,2)),Math.sqrt(Math.pow(o.xr,2)+Math.pow(o.yr,2)));f.left+=r.left*u.left,g.left+=r.left,h.left+=u.left,i.left+=Math.pow(r.left,2),l.left+=Math.pow(u.left,2),f.right+=r.right*u.right,g.right+=r.right,h.right+=u.right,i.right+=Math.pow(r.right,2),l.right+=Math.pow(u.right,2)}var v=new k(Math.sqrt(Math.pow(t.xl,2)+Math.pow(t.yl,2)),Math.sqrt(Math.pow(t.xr,2)+Math.pow(t.yr,2))),w=c-b+1;e.error.left=e.error.left/w/v.left,e.error.right=e.error.right/w/v.right;try{e.correl.left+=(w*f.left-g.left*h.left)/Math.sqrt(w*i.left-Math.pow(g.left,2))/Math.sqrt(w*l.left-Math.pow(h.left,2)),e.correl.right+=(w*f.right-g.right*h.right)/Math.sqrt(w*i.right-Math.pow(g.right,2))/Math.sqrt(w*l.right-Math.pow(h.right,2))}catch(x){}}return e},F=function(a,b,c,d,e){if(c>b)for(var f=b;c>=f;f++){var g=Math.round((f-b)/(c-b)*(s.length-1)),h=s[g],i=a[f];h.xl=(1-e)*h.xl+e*(i.ec.xl-d.xl),h.yl=(1-e)*h.yl+e*(i.ec.yl-d.yl),h.xr=(1-e)*h.xr+e*(i.ec.xr-d.xr),h.yr=(1-e)*h.yr+e*(i.ec.yr-d.yr)}},G=function(){for(var a=0;a<h.length;a+=1){var b=h[a];b.length<2&&(h.splice(a,1),a-=1)}},H=function(a,b){for(var c=0,d=0,e=0;e<a.length;e+=1)a[e]!=b&&(c+=a[e],d+=1);return d?c/d:0},I=function(a,b,c){for(var d=0,e=0,f=0;f<a.length;f+=1)a[f]!=c&&(d+=Math.pow(a[f]-b,2),e+=1);return e?Math.sqrt(d/e):0},J=function(a){for(var b=Number.MIN_VALUE,c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=Number.MAX_VALUE,f=Number.MIN_VALUE,g=Number.MAX_VALUE,h=Number.MIN_VALUE,i=Number.MAX_VALUE,k=0;k<a.length;k+=1){var l=a[k];b<l.xl&&(b=l.xl),c>l.xl&&(c=l.xl),d<l.yl&&(d=l.yl),e>l.yl&&(e=l.yl),f<l.xr&&(f=l.xr),g>l.xr&&(g=l.xr),h<l.yr&&(h=l.yr),i>l.yr&&(i=l.yr)}return new j(b-c,d-e,f-g,h-i)},K=function(a,b){var c=[];q=H(a,0),r=I(a,q,0);var d,e,f,g,i=(new j,Math.round(q));for(d=0;i>d;d+=1){var k=d/(i-1),l=new j,m=0;for(e=0;e<h.length;e+=1)a[e]&&(f=b[e]+Math.round(k*a[e]),g=h[e][f],l.xl+=g.ec.xl,l.yl+=g.ec.yl,l.xr+=g.ec.xr,l.yr+=g.ec.yr,m+=1);m&&(l.xl/=m,l.yl/=m,l.xr/=m,l.yr/=m),c.push(l)}return c},L=function(){var b,c,d=[],e=[],f=0,g=a.calibration.threshold;for(b=0;b<h.length;b+=1){var i=h[b];d[b]=z(i,0,1,i.length,1),c=z(i,i.length-1,i.length-2,0,-1);var j=d[b]<0?i.length-1:d[b]-1,k=C(i,0,j),l=0>c?0:c+1,m=C(i,l,i.length-1);D(i,0,i.length-1,k);var n=Math.sqrt(Math.pow(k.xl-m.xl,2)+Math.pow(k.yl-m.yl,2)),o=Math.sqrt(Math.pow(k.xr-m.xr,2)+Math.pow(k.yr-m.yr,2));d[b]>=0&&c>=0&&d[b]<c&&g>n&&g>o?e.push(c-d[b]+1):(e.push(0),f++)}return{startIndexes:d,durations:e,zeroSignalSizeCount:f}},M=function(){if(!(h.length<u)){G();var a=L(),b=a.zeroSignalSizeCount<h.length/2;b&&(s=K(a.durations,a.startIndexes),t=J(s))}},N=function(){y.fillStyle="white",y.fillRect(0,0,x.width,x.height),i.length>0&&O(i)},O=function(a){var b=x.width,c=x.height,d=24;y.font=d+"px Arial",y.textAlign="center",y.textBaseline="middle",y.fillStyle="#444",a.forEach(function(e,f){y.fillText(e,Math.round(b/2),Math.round(c/2)+1.5*d*(f-(a.length-1)/2))})},P=function(a){var b=x.width,c=x.height,d=function(d){y.beginPath();for(var e=0;e<a.length;e+=1){var f=a[e];0===e?y.moveTo(f.ec["x"+d]*b,f.ec["y"+d]*c):y.lineTo(f.ec["x"+d]*b,f.ec["y"+d]*c)}y.stroke()};y.strokeStyle="black",y.lineWidth=2,a&&(d("l"),d("r"))},Q=function(a){var b=x.width,c=x.height;y.fillStyle="red",y.beginPath(),y.arc(a.ec.xl*b,a.ec.yl*c,3,0,2*Math.PI),y.arc(a.ec.xr*b,a.ec.yr*c,3,0,2*Math.PI),y.fill()},R=function(){n=!1},S=function(b){p=null;var c=0;m+=1,2*u>m?m%2===1?(l=[],h.push(l),c=a.calibration.trialDuration,i=[],d&&d("start")):(l=null,c=a.calibration.pauseDuration,i=["Gesture recorded","Prepare for the next"],d&&d("stop")):m===2*u?(l=null,c=1e3,i=[],d&&d("stop")):m===2*u+1?(i=["Processing data","Please wait..."],N(),d&&d("processing"),M(),c=2e3,i=["Done!"],d&&d("processed")):m===2*(u+1)&&(i=[],b.hide(!0),d&&d("finished")),N(),c&&(p=setTimeout(S,c,b))};this.getBufferSize=function(){return q+4*r+20},this.init=function(a){d=a,h=[],s=null,l=null,m=0,n=!1,o=!0,this.show(),p=setTimeout(S,g+1500,this),i=["Task: "+u+" head gesture"+(u>1?"s":""),"Prepare for the first gesture"],N()},this.finilize=function(){l=null},this.detect=function(a,b){var c={detected:!1};if(!s)return c;var d,g=z(a,0,1,a.length-1,1),h=z(a,a.length-1,a.length-1,0,-1),i={error:new k,correl:new k},j=h-g+1;return g>0&&h>0&&h>g&&j>A()&&j<B()&&(c.detected=!0,d=C(a,0,g-1),i=E(a,g,h,d),(i.error.left>e||i.error.right>e||i.correl.left<f||i.correl.right<f)&&(c.detected=!1,o=!0),c.detected&&b&&o&&g>10&&h<a.length-1&&(F(a,g,h,d,.3),o=!1)),c.detected&&(c.detected=a[g-1].focused),c.detected&&!n&&(n=!0,setTimeout(R,1e3)),c},this.feed=function(a){l&&l.push(a),N(),0===i.length&&(P(l),Q(a))},this.show=function(){v.style.display="block"},this.hide=function(a){v.style.display="none",p&&(clearTimeout(p),p=null),a&&c&&c()}}function m(a,b){this.modes={none:0,calibration:1,training:2,detection:3},this.current=null;var c=new l(b,function(){}),d=a,e=this.modes.none,f=null,g=!1,h=0,j=new i,k=!0,m=function(a,b){var c,d=f.length;for(c=f.length-1;c>=0;c-=1)if(f[c].isValid()){d=c;break}if(d<f.length){var e=f.length-d,g=f[d];for(c=d+1;c<f.length;c+=1){var h=(c-d)/e;f[c]=new i(g.timestamp+(a-g.timestamp)*h,{xl:g.ec.xl+(b.xl-g.xl)*h,yl:g.ec.yl+(b.yl-g.yl)*h,xr:g.ec.xr+(b.xr-g.xr)*h,yr:g.ec.yr+(b.yr-g.yr)*h},f[c].focused)}}},n=function(a){var d=a-h>b.detection.minPause,i=b.detection.alterRefSignalOnDetection&&!g&&d,k={};return e===this.modes.training?(k=c.detect(f,i),c.feed(j)):e===this.modes.detection&&(k=c.detect(f,i),!g&&d&&(k.valid=!0)),k.detected&&(h=a),g=!!k.detected,k};this.getName=function(){return d},this.init=function(a,b){e=a,this.current=null,f=e===this.modes.calibration?null:[],g=!1,h=0,j=new i,k=!0,e===this.modes.calibration&&c.init(b)},this.finilize=function(){c.finilize(),f=null,e=this.modes.none},this.feed=function(a,b,d){if(e==this.modes.none)return null;var g=!0;if(j.isSet()){var h=j.ec.xl-b.xl,l=j.ec.yl-b.yl,o=j.ec.xr-b.xr,p=j.ec.yr-b.yr;g=Math.sqrt(Math.pow(h,2)+Math.pow(l,2))<.2&&Math.sqrt(Math.pow(o,2)+Math.pow(p,2))<.2}if(g?(j=new i(a,b,d),!k&&f&&f.length>0&&m(a,b)):j.timestamp=-1,k=g,e===this.modes.calibration)c.feed(j);else if(f.length===c.getBufferSize()){if(f.shift(),f.push(j),g){var q=n.call(this,a);this.current=q.valid?q.detected:null}}else f.push(j);return this.current}}function n(a,b,c){function d(a){var b=a,c=150,d=150,e=300,f=12,g=20,h=function(a){var h=Math.log((b.dwellTime+d)/e)*f;h+=a,b.dwellTime=Math.round((e*Math.exp(h/f)-d)/g)*g,b.dwellTime<c&&(b.dwellTime=c)};this.increase=function(){h(1)},this.decrease=function(){h(-1)}}this.options=a;var e={};e.layout=a.layout||'["!|!|1,?|?|2,:|:|3,;|;|4,\\u0027|\\u0027|5,\\u0022|\\u0022|6,&|&|7,@|@|8,(|(|9,)|)|0",{"titles":["backspace.png"], "commands":["backspace"]}],\n["q|Q|+,w|W|-:,e|E|*,r|R|\\/,t|T|=,y|Y|%,u|U|$,i|I|#,o|O|(,p|P|)",{"titles":["enter.png"], "commands":["enter"]}],\n["a|A|@,s|S|~,d|D|^,f|F|\\u005C,g|G|_,h|H|&,j|J|[,k|K|],l|L|\\u007B, | |\\u007D",{"titles":["symbols.png","symbols.png","upcase.png"], "commands":["symbols","symbols","upcase"]}],\n["z|Z|,x|X|,c|C|,v|V|,b|B| ,n|N|,m|M|",{"titles":[",","<","<"], "commands":[",","<","<"]},".|>|>",{"titles":["upcase.png","lowcase.png"], "commands":["upcase","lowcase"]},{"titles":["send.png"], "commands":["custom"]}]',e.callbacks=a.callbacks||{},e.imageFolder=a.imageFolder||"/images/kbd/"+a.name+"/",e.className={container:"etud-keyboard "+((a.className?a.className.container:"")||"etud-keyboardDefault"),button:"etud-keyboard-button "+((a.className?a.className.button:"")||"etud-keyboard-buttonDefault")};var f=c||{},g=document.createElement("table");g.className=e.className.container,g.classList.add("etud-keyboard-invisible");var h=0,i={lowcase:0,upcase:1,symbols:2},j={dwell:"dwell"},k=[],l=null,m=new d(a.selection),n=this,o={hide:function(){F()},backspace:function(){var a=l||document.activeElement;if(a){var b=a.selectionStart,c=a.value;if(void 0!==b&&void 0!==c&&b>0){var d=c.substr(0,b-1),e=c.substr(b);a.value=d+e,a.selectionStart=b-1,a.selectionEnd=b-1}}},enter:function(){s("Enter",13)},left:function(){s("Left",37)},right:function(){s("Left",39)},up:function(){s("Up",38)},down:function(){s("Down",40)},home:function(){s("Home",36)},end:function(){s("End",35)},pageup:function(){s("PageUp",33)},pagedown:function(){s("PageDown",34)},dwellInc:function(){m.increase()},dwellDec:function(){m.decrease()},custom:function(a){a in e.callbacks&&e.callbacks[a](n)}},p=function(b){return b===j.dwell?a.selection.dwellTime:void 0},q=function(a,b,c){var d=p(c);d!=a.indicator.value&&(a.indicator.value=d,b.innerHTML=d)},r=function(a,b){var c=Object.prototype.toString.call(b).slice(8,-1);return void 0!==b&&null!==b&&c===a},s=function(a,b){function c(a){if("textarea"==a.tagName.toLowerCase()){var b=a.value.substr(0,a.selectionEnd),c=a.value.substr(a.selectionEnd);a.value=b+"\n"+c}else{var d=new KeyboardEvent("keydown",{key:"Enter",code:13,shiftKey:!1});a.dispatchEvent(d)}}function d(a){a.selectionEnd=a.selectionStart=a.value.lastIndexOf("\n",a.selectionEnd-1)+1}function e(a){var b=a.selectionEnd,c=a.value.indexOf("\n",b);-1===c&&(c=a.value.length),a.selectionStart=a.selectionEnd=c}function f(a){a.selectionStart=a.selectionEnd-=1}function g(a){a.selectionStart=a.selectionEnd+=1}function h(a){var b=a.selectionEnd,c=a.value.lastIndexOf("\n",b),d=a.value.indexOf("\n",b+1);-1!==d&&(b-=c,a.selectionStart=a.selectionEnd=d+b)}function i(a){var b=a.selectionEnd,c=a.value.lastIndexOf("\n",b),d=a.value.lastIndexOf("\n",c-1);-1!==c&&(b-=c,a.selectionStart=a.selectionEnd=d+b)}var j=l||document.activeElement;j&&(13==b?c(j):33==b||34==b||(35==b?e(j):36==b?d(j):37==b?f(j):38==b?i(j):39==b?g(j):40==b&&h(j)))},t=function(a){h=a;var b,c,d;for(b=0;b<k.length;b++)for(d=k[b],c=0;c<d.length;c++)d[c].invalid||(d[c].dom.parentElement.style.display="table-cell");for(b=0;b<k.length;b++)for(d=k[b],c=0;c<d.length;c++)d[c].invalid||d[c].update()},u=function(a){var b=[];try{var c='{"layout": ['+a+"] }",d=JSON.parse(c);if(void 0===d.layout||!r("Array",d.layout))throw'- the JSON object has no "layout" property, or it is not an array';b=d.layout}catch(e){console.log("The definition of layout\n"+a+"\n\nis not valid:\n"+e.message)}return b},v=function(a,b){var c="";return a&&(a.length>b?c=a[b]:a.length>0&&(c=a[0])),c},w=function(a){for(var b=a.split(","),c=[],d=0;d<b.length;d++)c.push(x(b[d]));return c},x=function(a){var b={titles:[],commands:[]};if(r("String",a)){var c,d,e=a.split("|");if(e.length)for(c=0;c<e.length;c++)if(d=e[c]){var f=d.split(":");!f[0]&&f.length>1?(b.titles.push(":"),b.commands.push(f[1]||":")):1==f.length?(b.titles.push(d),b.commands.push(d)):(b.titles.push(f[0]),b.commands.push(f[1]))}else b.titles.push(""),b.commands.push("")}return y(b),b},y=function(a){a.titles=r("Array",a.titles)?a.titles:[],a.commands=r("Array",a.commands)?a.commands:[];var b;if(a.titles.length<a.commands.length)for(b=a.titles.length;b<a.commands.length;b++)a.titles.push(a.commands[b]);else if(a.commands.length<a.titles.length)for(b=a.commands.length;b<a.titles.length;b++)a.commands.push(a.titles[b]);var c="",d="";for(a.titles.length&&(c=a.titles.slice(-1)[0],d=a.commands.slice(-1)[0]),b=a.titles.length;b<Object.keys(i).length;b++)a.titles.push(c),a.commands.push(d);for(b=0;b<a.commands.length;b++){var e=a.commands[b].split(".");e.length>1&&"png"==e[e.length-1].toLowerCase()&&(e.pop(),a.commands[b]=e.join("."))}"undefined"!=typeof a.zoom&&(a.zoom.length||(a.zoom=[a.zoom,a.zoom,a.zoom]))},z=function(){var a=g.insertRow(-1);return a},A=function(a,c){var d=document.createElement("div");d.className=e.className.button,d.classList.add(b.button),d.addEventListener("mousedown",function(a){C(c),a.preventDefault(),a.stopPropagation()},!1);var f=document.createElement("div");d.appendChild(f);var g=a.insertCell(-1);return g.appendChild(d),c?(c.dom=d,c.update=function(){c.indicator&&(clearInterval(c.indicator.timer),c.indicator=null);var a=c?v(c.titles,h):"";d.style.visibility=a.length?"visible":"hidden";var i=c.commands[h],k=i in j;k?d.classList.add(b.indicator):d.classList.remove(b.indicator),f.innerHTML="",f.style.backgroundImage="";var l=a.split(".");l.length>1&&"png"==l[l.length-1].toLowerCase()?f.style.backgroundImage="url('"+e.imageFolder+a+"')":k?c.indicator={timer:setInterval(function(){q(c,f,i)},50),value:null}:f.innerHTML=a;var m=c.zoom?Math.round(c.zoom[h]):1;if(g.colSpan=m>1?m:1,m>1)for(var n=g.nextElementSibling;n&&m>1;)n.style.display="none",n=n.nextElementSibling,m-=1},c.update(),void 0):(d.invalid=!0,void 0)},B=function(a){for(;g.hasChildNodes();)g.removeChild(g.lastChild);k=r("Array",a)?a:u(a);var b,c,d,e,f,h=k.length;for(b=0;h>b;b++)for(d=k[b],r("Array",d)||(d=[d],k[b]=d),c=0;c<d.length;c++)f=d[c],r("String",f)?(e=w(f),d.splice.apply(d,[c,1].concat(e)),c+=e.length-1):r("Object",f)&&y(f);for(b=0;h>b;b++)for(d=z(),e=k[b],c=0;c<e.length;c++)A(d,e[c])},C=function(a){D(a.commands[h],a.titles[h])},D=function(a,b){if(a)if(a in o){var c=b,d=c.split(".");d.length>1&&"png"==d[d.length-1].toLowerCase()&&(d.pop(),c=d.join(".")),o[a](c)}else if(a in i)t(i[a]);else{var e=l||document.activeElement;if(e){var f=e.selectionStart,g=e.value;if(void 0!==f&&void 0!==g){var h=g.substr(0,f),j=g.substr(f);e.value=h+a+j,e.selectionStart=f+a.length,e.selectionEnd=f+a.length}}}},E=function(){g.classList.remove("etud-animated"),g.classList.remove("etud-animated-fadeOutDown"),g.classList.add("etud-animated-fadeInUp"),g.classList.add("etud-animated"),f.show&&f.show(n)},F=function(){g.classList.remove("etud-animated"),g.classList.remove("etud-animated-fadeInUp"),g.classList.add("etud-animated-fadeOutDown"),g.classList.add("etud-animated"),f.hide&&f.hide()};this.reset=function(){t(0)},this.show=function(a){if(l=r("String",a)?document.getElementById(a):a,g.classList.remove("etud-keyboard-invisible"),l){var b="etud-keyboard-stickBottom",c=l.getBoundingClientRect(),d=window.innerHeight-c.bottom<g.offsetHeight,f=c.top<g.offsetHeight,h=l.ownerDocument.documentElement,i=h.clientHeight-(l.offsetTop+l.offsetHeight),j=i>g.offsetHeight,k=l.offsetTop>g.offsetHeight,m=null,n=function(){var a=g.getBoundingClientRect();return c.top+c.height-a.top+20},o=function(){return-(g.offsetHeight-c.top)-20};!d||j?d&&(m=n):!f||k?(b="etud-keyboard-stickTop",f&&(m=o)):(g.classList.add(e.className.container+"-shrinked"),m=n),g.classList.add(b);var p=function(){var a=m?m():0;if(a){var b=10,c=20,d=function(){var e=0>a?Math.max(-b,a):Math.min(b,a);a-=e,window.scrollBy(0,e),a&&setTimeout(d,c)};setTimeout(d,c)}g.removeEventListener("animationend",p,!1),g.removeEventListener("webkitAnimationEnd",p,!1)};g.addEventListener("animationend",p,!1),g.addEventListener("webkitAnimationEnd",p,!1),l.focus()}E()},this.hide=function(){F();var a=function(){g.classList.add("etud-keyboard-invisible"),g.classList.remove("etud-keyboard-shrinked"),g.classList.remove("etud-keyboard-stickTop"),g.removeEventListener("animationend",a,!1),g.removeEventListener("webkitAnimationEnd",a,!1)};g.addEventListener("animationend",a,!1),g.addEventListener("webkitAnimationEnd",a,!1)},this.isVisible=function(){return"none"!==g.style.display},this.getDOM=function(){return g},this.getState=function(){return h},this.getInputElem=function(){return l},this.print=function(a,b){D(a,b)},B(e.layout),document.body.appendChild(g)}function o(b){var c=!1,d=null,e={speed:0,timer:null},f=function(a){a.classList.remove("etud-animation"),a.classList.remove("etud-animated-fadeOutHalf"),a.classList.add(b.className+"-keyOpaque"),a.classList.add("etud-animated-fadeInHalf"),a.classList.add("etud-animated")},g=function(a){a.classList.remove(b.className+"-keyOpaque"),a.classList.remove("etud-animation"),a.classList.remove("etud-animated-fadeInHalf"),a.classList.add("etud-animated-fadeOutHalf"),a.classList.add("etud-animated")},h=function(){if(!this.scroller.timer){var a=this.scroller.speed,b=this.scroller.direction,d=this;this.scroller.timer=setInterval(function(){return c?(a>0?scrollBy(0,a*b):0>a&&scrollBy(0,Math.round(.9*window.innerHeight*b)),void 0):(clearInterval(d.scroller.timer),d.scroller.timer=null,g(d),void 0)},a>0?20:1e3)}},i=function(){f(this)},j=function(){this.scroller.timer&&(clearInterval(this.scroller.timer),this.scroller.timer=null),g(this)},k=function(c,d){for(var e=c.insertRow(-1),f=0;f<b.speeds.length;f+=1){var g=b.speeds[f],k=document.createElement("div");k.className=b.className+"-key";var l=d?"Up":"Down",m="";g>0?m="smooth"+l:0>g&&(m="page"+l),m&&(k.style.backgroundImage="url('"+b.imageFolder+m+".png')"),k.scroller={speed:g,direction:d?-1:1,timer:null},k.addEventListener(a.etudriver.event.selected,h),k.addEventListener(a.etudriver.event.focused,i),k.addEventListener(a.etudriver.event.left,j);var n=e.insertCell(-1);n.appendChild(k)}},l=function(a){var c=document.createElement("table");c.className=b.className,c.classList.add(b.className+(a?"-upper":"-lower")),k(c,a),document.body.appendChild(c)},m=function(a){var b=0,c=0,d=0;return a.xl&&(c+=a.xl,d+=a.yl,b+=1),a.xr&&(c+=a.xr,d+=a.yr,b+=1),b&&(c/=b,d/=b),{x:c,y:d}};if(b.type===a.etudriver.scroller.fixation){l(!0),l(!1)}this.init=function(){c=!0},this.feed=function(a){d||(d=m(a));var f=m(a),g=f.y-d.y;Math.abs(g)>=b.headPose.threshold?(e.speed=(Math.abs(g)-b.headPose.threshold)*(0>g?-1:1)*b.headPose.transformParam,e.timer||(e.timer=setInterval(function(){return c?(e.speed&&scrollBy(0,e.speed),void 0):(clearInterval(e.timer),e.timer=null,void 0)},20))):(e.speed=0,e.timer&&(clearInterval(e.timer),e.timer=null))},this.reset=function(){c=!1,d=null,e.speed=0,e.timer&&(clearInterval(e.timer),e.timer=null)}}function p(a){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=[],s=a,t=20,u=500,v=20,w=0,x=-1,y=!1,z=new b,A=function(a){vb("CalibrationVerifier","onFullScreenChanged, e = "),console.log(a),x>=0||z.isActive&&E()},B=function(a){vb("CalibrationVerifier","onFullScreenError, e = "),console.log(a)};z.addEventListener("change",A),z.addEventListener("error",B),this.run=function(a,b){j=Hb(!0,{},b),s=Hb(!0,{},s,a),q=Db(),D(),c||C(),e.style.display="none",f.style.display="none",h.style.display="none",i.style.display="none",s.display?(c.style.display="block",d.style.display="block",z.isActive?0>x&&E():z.request(c)):0>x&&(c.style.display="none",d.style.display="none",E())},this.feed=function(a,b,c){y&&r[x].samples.push({ts:a,x:b,y:c})},this.isActive=function(){return y};var C=function(){c=document.createElement("div"),c.className="etud-calibVerifier-container",c.classList.add(s.className.container),d=document.createElement("div"),d.className="etud-calibVerifier-target",d.classList.add(s.className.target),d.style.width=s.size+"px",d.style.height=s.size+"px",d.style.borderRadius=s.size/2+"px",e=document.createElement("div"),e.className="etud-calibVerifier-pulsator",e.classList.add(s.className.pulsator),f=document.createElement("canvas"),f.width=q.width,f.height=q.height,f.className="etud-calibVerifier-canvas",f.addEventListener("click",Q),f.addEventListener("keyup",Q),h=document.createElement("div"),h.className="etud-calibVerifier-rating";for(var a=["Amplitude","Uniformity"],b=0;2>b;++b){if(b>0){var j=document.createElement("div");j.className="spacer",h.appendChild(j)}var k=document.createElement("span");k.textContent=a[b],h.appendChild(k);for(var l=0;5>l;++l){var m=document.createElement("div");m.className="star empty",h.appendChild(m)}}i=document.createElement("div"),i.className="close",i.addEventListener("click",Q),c.appendChild(f),c.appendChild(e),c.appendChild(d),c.appendChild(h),c.appendChild(i),document.body.appendChild(c),g=f.getContext("2d")},D=function(){r=[];for(var a=0;a<s.rows;a++)for(var b=0;b<s.columns;b++)r.push({location:{x:(b+.5)/s.columns,y:(a+.5)/s.rows},cell:{row:a,col:b},samples:[]});for(a=0;a<3*r.length;a++){var c=Eb(r.length-1),d=Eb(r.length-1),e=r[c];r[c]=r[d],r[d]=e}},E=function(){vb("CalibrationVerifier","starting the verification"),o=0,n=Math.floor(s.transitionDuration/t)+1,F()},F=function(){if(y=!1,e.style.display="none",clearInterval(w),w=0,x>=0&&j.targetFinished){vb("CalibrationVerifier","collected "+m.samples.length+" samples");var a=x+1===r.length?null:r[x+1];a&&(a={location:Fb(a.location),cell:Fb(a.cell)}),j.targetFinished(m,a)}if(x++,0===x&&j.started){var b=r[0],a={location:Fb(b.location),cell:Fb(b.cell)};j.started(a)}x<r.length?(vb("CalibrationVerifier","target #"+x),s.transitionDuration>0?(vb("CalibrationVerifier","animating"),l=0===x?{x:0,y:0}:m.location,m=r[x],setTimeout(G,t)):(m=r[x],I())):(s.displayResults&&(k=setTimeout(Q,1e3*s.displayResults)),x=-1,L())},G=function(){if(o++,n>o){var a=(m.location.x-l.x)/n,b=(m.location.y-l.y)/n;H(l.x+a*o,l.y+b*o),setTimeout(G,t)}else o=0,I()},H=function(a,b){d.style.left=Math.round(a*q.width)-s.size/2+"px",d.style.top=Math.round(b*q.height)-s.size/2+"px"},I=function(){vb("CalibrationVerifier","target is displaying");var a=r[x];if(H(a.location.x,a.location.y),setTimeout(J,u),setTimeout(F,s.duration),j.targetStarted){var b={location:Fb(a.location),cell:Fb(a.cell)};j.targetStarted(b)}},J=function(){s.pulsation.enabled&&(K(),e.style.display="block",p=(new Date).getTime(),w=setInterval(K,v)),y=!0},K=function(){var a=(new Date).getTime()-p,b=Math.PI*(a/s.pulsation.duration%1),c=Math.sin(b)*s.pulsation.size,d=r[x];e.style.left=Math.round(d.location.x*q.width)-s.size/2-c+"px",e.style.top=Math.round(d.location.y*q.height)-s.size/2-c+"px",e.style.width=s.size+2*c+"px",e.style.height=s.size+2*c+"px",e.style.borderRadius=(s.size+2*c)/2+"px"},L=function(){vb("CalibrationVerifier","reporting results");var a,b;d.style.display="none",f.style.display="block",h.style.display="block",i.style.display="block",g.clearRect(0,0,q.width,q.height),g.font="16pt Arial";var c={amplitude:{mean:0,std:0},angle:{mean:{sin:0,cos:0},std:0},std:{mean:0,std:0},targets:[],apx:{},interpretation:[]},e=Array.apply(null,new Array(s.columns)).map(function(){return 0}),k=Array.apply(null,new Array(s.rows)).map(function(){return 0});for(a=0,b=r.length;b>a;++a){var l=r[a],m={x:l.location.x*q.width,y:l.location.y*q.height};g.fillStyle=s.resultColors.target,g.beginPath(),g.arc(Math.round(m.x),Math.round(m.y),s.size/2,0,2*Math.PI),g.fill();var n=M(l.samples,m);n&&(n.location=m,n.cell=l.cell,c.targets.push(n),c.amplitude.mean+=n.amplitude.abs,c.angle.mean.sin+=Math.sin(n.angle),c.angle.mean.cos+=Math.cos(n.angle),c.std.mean+=n.std,e[l.cell.col]+=n.amplitude.h,k[l.cell.row]+=n.amplitude.v,g.fillStyle=s.resultColors.offset,g.beginPath(),g.arc(Math.round(m.x+n.amplitude.abs*Math.cos(n.angle)),Math.round(m.y+n.amplitude.abs*Math.sin(n.angle)),n.std,0,2*Math.PI),g.fill())}if(c.targets.length>0){for(c.amplitude.mean/=c.targets.length,c.angle.mean.sin/=c.targets.length,c.angle.mean.cos/=c.targets.length,c.std.mean/=c.targets.length,a=0,b=c.targets.length;b>a;++a){var o=c.targets[a];c.amplitude.std+=Math.pow(o.amplitude.abs-c.amplitude.mean,2),c.std.std+=Math.pow(o.std-c.std.mean,2)}c.amplitude.std=Math.sqrt(c.amplitude.std/(b-1)),c.std.std=Math.sqrt(c.std.std/(b-1)),c.angle.std=Math.sqrt(Math.pow(c.angle.mean.sin,2)+Math.pow(c.angle.mean.cos,2)),c.angle.mean=Math.atan2(c.angle.mean.sin,c.angle.mean.cos),e=e.map(function(a,b){return{x:(2*b+1)/s.columns-1,y:a/s.rows}}),k=k.map(function(a,b){return{x:(2*b+1)/s.rows-1,y:a/s.columns}}),c.apx={h:N(e,2),v:N(k,2)};var p=!(!c.apx.h||!c.apx.v);if(p){var t=O(c.apx.h,["left","right"]),u=O(c.apx.v,["top","bottom"]);c.interpretation=P(t,u,c.amplitude),g.fillStyle=s.resultColors.text,g.fillText(c.interpretation.text[1],10,q.height-50),g.fillText(c.interpretation.text[0],10,q.height-25);var v=h.querySelectorAll(".star");for(a=0,b=v.length;b>a;++a){var w=v[a],x=5>a?c.interpretation.rating.amplitude:c.interpretation.rating.uniformity,y=x/2-a%5;w.className=y>.75?"star full":y>.25?"star half":"star empty"}}}j.finished&&j.finished(c)},M=function(a,b){var c,d,e,f={x:0,y:0},h=null;for(g.fillStyle=s.resultColors.sample,d=0,e=a.length;e>d;++d)c=a[d],f.x+=c.x-b.x,f.y+=c.y-b.y,g.beginPath(),g.arc(Math.round(c.x),Math.round(c.y),2,0,2*Math.PI),g.fill();if(a.length>1){f.x/=a.length,f.y/=a.length;var i=Math.sqrt(f.x*f.x+f.y*f.y),j=Math.atan2(f.y,f.x),k=0,l={x:b.x+f.x,y:b.y+f.y};for(d=0,e=a.length;e>d;++d){c=a[d];var m=c.x-l.x,n=c.y-l.y;k+=m*m+n*n}k=Math.sqrt(k/(e-1)),h={amplitude:{h:Math.abs(f.x),v:Math.abs(f.y),abs:i},angle:j,std:k}}return h},N=function(a,b){var c,d,e,f=a.length;if(b+1>f)return null;var g=new Array(b+1),h=new Array(b+1),i=new Array(f),j=new Array(f),k=new Array(b+1);for(e=0;f>e;++e){var l=a[e];i[e]=l.x,j[e]=l.y}for(c=0;b>=c;++c)for(g[c]=0,h[c]=0,k[c]=new Array(b+1),d=0;b>=d;++d)for(k[c][d]=0,e=0;f>e;++e)k[c][d]+=Math.pow(i[e],c+d);for(c=0;b>=c;++c)for(e=0;f>e;++e)h[c]+=Math.pow(i[e],c)*j[e];var m=0;for(c=0;b>=c;++c)if(0===k[c][c])for(d=0;b>=d;++d)if(d!==c&&0!==k[d][c]&&0!==k[c][d]){for(e=0;b>=e;++e)m=k[d][e],k[d][e]=k[c][e],k[c][e]=m;m=h[d],h[d]=h[c],h[c]=m;break}for(e=0;b>=e;++e)for(c=e+1;b>=c;++c){if(0===k[e][e])return null;var n=k[c][e]/k[e][e];for(d=e;b>=d;++d)k[c][d]-=n*k[e][d];h[c]-=n*h[e]}for(c=b;c>=0;--c){var o=0;for(d=c;b>=d;++d)o+=k[c][d]*g[d];g[c]=(h[c]-o)/k[c][c]}return g},O=function(a,b){var c=function(a,b){for(var c=0,d=0,e=a.length;e>d;++d)c+=a[d]*Math.pow(b,d);return c},d=s.interpretationThreshold,e=[c(a,-1),c(a,0),c(a,1)],f=[(e[0]-e[1])/d,(e[2]-e[1])/d,(e[0]-e[2])/d],g=-1,h=0,i=1,j=function(a){var b=h;return-1>=a?b=g:a>=1&&(b=i),b};f=f.map(j);var k,l=0,m=1,n=2,o=[Number.NaN,Number.NaN,Number.NaN],p={muchWorse:-2,worse:-1,equal:0,better:1,muchBetter:2},q={flat:"flat",lowGradient:"low gradient",highGradient:"high gradient",side:"high side",lowCone:"low cone",highCone:"high cone"};f[0]===g&&f[1]===g?(o[m]=p.muchWorse,k=q.highCone):f[0]===i&&f[1]===i?(o[m]=p.muchBetter,k=q.highCone):f[0]===g&&f[1]===h&&f[2]===g?(o[l]=p.muchBetter,k=q.side):f[0]===g&&f[1]===h&&f[2]===h?(o[l]=p.better,o[m]=p.worse,k=q.lowCone):f[0]===g&&f[1]===i&&f[2]===g?(o[l]=p.better,o[n]=p.worse,k=q.highGradient):f[0]===h&&f[1]===g&&f[2]===h?(o[n]=p.better,o[m]=p.worse,k=q.lowCone):f[0]===h&&f[1]===g&&f[2]===i?(o[n]=p.muchBetter,k=q.side):f[0]===h&&f[1]===h&&f[2]===g?(o[l]=p.better,k=q.lowGradient):f[0]===h&&f[1]===h&&f[2]===h?(o[m]=p.equal,k=q.flat):f[0]===h&&f[1]===h&&f[2]===i?(o[n]=p.better,k=q.lowGradient):f[0]===h&&f[1]===i&&f[2]===g?(o[n]=p.muchWorse,k=q.side):f[0]===h&&f[1]===i&&f[2]===h?(o[n]=p.worse,o[m]=p.better,k=q.lowCone):f[0]===i&&f[1]===g&&f[2]===i?(o[l]=p.worse,o[n]=p.better,k=q.highGradient):f[0]===i&&f[1]===h&&f[2]===h?(o[l]=p.worse,o[m]=p.better,k=q.lowCone):f[0]===i&&f[1]===h&&f[2]===i&&(o[l]=p.muchWorse,k=q.side);var r=["much worse","worse","","better","much better"],t=" at ",u=" to ",v="gradually worsening from ",w=[];return isNaN(o[m])?isNaN(o[l])?isNaN(o[n])||w.push(r[o[n]+2]+t+b[1]):isNaN(o[n])?w.push(r[o[l]+2]+t+b[0]):o[l]>o[n]?w.push(v+b[0]+u+b[1]):w.push(v+b[1]+u+b[0]):(isNaN(o[l])?isNaN(o[n])||w.push(r[o[n]+2]+t+b[1]):w.push(r[o[l]+2]+t+b[0]),0!==o[m]?w.push(r[o[m]+2]+t+"center"):w.push("about equal")),{text:w,type:k}},P=function(a,b,c){var d,e=[],f=[];a.text.length?e.push(a.text.join(", ")+" in the horizontal dimension"):f.push(" horizontal"),b.text.length?e.push(b.text.join(", ")+" in the vertical dimension"):f.push(" vertical"),e.length>0&&(d=e.join(", "),e=["Interpretation: calibration is ",d,"."]),f.length>0&&(d=f.join(" and "),f=["Cannot interpretate results for the ",d," dimension."]);var c=10-Math.floor(2*c.mean/s.interpretationThreshold),g=function(a,b){return new RegExp(a).test(b)},h=10;h-=g("gradient|cone|side",a.type)?2:0,h-=g("gradient|cone|side",b.type)?2:0,h-=g("high",a.type)?2:0,h-=g("high",b.type)?2:0;var i={text:[e.join(""),f.join("")],rating:{amplitude:Math.max(1,c),uniformity:Math.max(1,h)}};return i},Q=function(){c.style.display="none",z.exit(),k&&(clearTimeout(k),k=0)}}a.etudriver={mapping:{none:0,naive:1,expanded:2},selection:{none:0,cumulativeDwell:1,simpleDwell:2,nod:3,customHeadGesture:4},source:{samples:0,fixations:1},event:{focused:"focused",left:"left",selected:"selected"},scroller:{fixation:0,headPose:1},keyboard:{"default":{layout:'["!|!|1,?|?|2,:|:|3,;|;|4,\\u0027|\\u0027|5,\\u0022|\\u0022|6,&|&|7,@|@|8,(|(|9,)|)|0",{"titles":["backspace.png"], "commands":["backspace"]}],\n["q|Q|+,w|W|-:,e|E|*,r|R|\\/,t|T|=,y|Y|%,u|U|$,i|I|#,o|O|(,p|P|)",{"titles":["enter.png"], "commands":["enter"]}],\n["a|A|@,s|S|~,d|D|^,f|F|\\u005C,g|G|_,h|H|&,j|J|[,k|K|],l|L|\\u007B, | |\\u007D",{"titles":["symbols.png","symbols.png","upcase.png"], "commands":["symbols","symbols","upcase"]}],\n["z|Z|,x|X|,c|C|,v|V|,b|B| ,n|N|,m|M|",{"titles":[",","<","<"], "commands":[",","<","<"]},".|>|>",{"titles":["upcase.png","lowcase.png"], "commands":["upcase","lowcase"]},{"titles":["close.png"], "commands":["hide"]}]',callbacks:{},imageFolder:"images/kbd/default/",className:{container:"etud-keyboardDefault",button:"etud-keyboard-buttonDefault"},selection:{type:1},mapping:{}}},settings:{selection:{defaults:{className:"etud-selected",duration:200,audio:"click.wav"},cumulativeDwell:{dwellTime:1e3,showProgress:!0},simpleDwell:{dwellTime:1e3,showProgress:!0},nod:[{matchAll:!0,interval:{min:80,max:120},left:{amplitude:{min:0,max:.005},angle:{min:0,max:0}},right:{amplitude:{min:0,max:.005},angle:{min:0,max:0}}},{matchAll:!1,interval:{min:100,max:200},left:{amplitude:{min:.015,max:.04},angle:{min:70,max:110}},right:{amplitude:{min:.015,max:.04},angle:{min:70,max:110}}},{matchAll:!1,interval:{min:100,max:200},left:{amplitude:{min:.015,max:.04},angle:{min:250,max:290}},right:{amplitude:{min:.015,max:.04},angle:{min:250,max:290}}},{matchAll:!0,interval:{min:80,max:120},left:{amplitude:{min:0,max:.005},angle:{min:0,max:0}},right:{amplitude:{min:0,max:.005},angle:{min:0,max:0}}}]},mapping:{defaults:{className:"etud-focused"},expanded:{expansion:50}}}};
var q={panel:{show:!0,displaySamples:!1,id:"etud-panel",connectedClassName:"etud-panel-connected"},targets:[{selector:".etud-target",keyboard:null,selection:{type:a.etudriver.selection.cumulativeDwell},mapping:{}}],mapping:{type:a.etudriver.mapping.naive,source:a.etudriver.source.samples},pointer:{show:!0,size:8,color:"MediumSeaGreen",opacity:.5,smoothing:{enabled:!0,low:300,high:10,timeWindow:50,threshold:25}},progress:{color:"Teal",opacity:.5,size:60,minWidth:5,delay:200},fixdet:{maxFixSize:50,bufferLength:10},headCorrector:{enabled:!0,transformParam:500},headGesture:{timeWindow:800},customHeadGestureDetector:{calibration:{trials:5,threshold:.012,trialDuration:2e3,pauseDuration:2e3,plotSizeFactor:1},detection:{maxAmplitudeError:.2,minCorrelation:.85,minPause:500,alterRefSignalOnDetection:!1}},css:{file:"etudriver",useVersion:!0},scroller:{enabled:!1,speeds:[2,7,15,-1],type:a.etudriver.scroller.headPose,className:"etud-scroller",imageFolder:"images/scroller/",size:80,delay:800,headPose:{threshold:.005,transformParam:500}},calibVerifier:{display:!0,rows:4,columns:5,size:12,duration:1500,transitionDuration:800,displayResults:60,interpretationThreshold:20,pulsation:{enabled:!1,duration:600,size:20},className:{container:"etud-calibVerifier-containerDefault",target:"etud-calibVerifier-targetDefault",pulsator:"etud-calibVerifier-pulsatorDefault"},resultColors:{target:"#444",sample:"#48C",offset:"rgba(224,160,64,0.5)",text:"#444"}},port:8086,frequency:0},r={state:null,sample:null,target:null,keyboard:null};a.etudriver.init=function(b,c){var g=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("link");c.rel="stylesheet",c.type="text/css",c.href=a,c.media="all",b.appendChild(c)},i=function(){var a=function(){return-1!==navigator.userAgent.indexOf("MSIE")},b='\n            <span id="etud-device"></span>\n            <input id="etud-showOptions" type="button" value="Options" disabled />\n            <input id="etud-calibrate" type="button" value="Calibrate" disabled />\n            <input id="etud-toggleTracking" type="button" value="Start" disabled />\n            <span id="etud-chgd-calibMenu"><ul><li><a href="#">Calibrate gesture</a><ul id="etud-chgd-calibList"></ul></li></ul></span>\n            <span id="etud-log"></span>\n            ';J=document.createElement("div"),J.id=q.panel.id,J.innerHTML=b;var c=window.getComputedStyle(document.body).paddingTop;document.body.insertBefore(J,document.body.firstChild),document.body.style.margin="0px",a()||setTimeout(function(){document.body.style.paddingTop=Math.max(parseInt(c,10),J.scrollHeight)+"px"},100),K=document.getElementById("etud-device"),L=document.getElementById("etud-showOptions"),M=document.getElementById("etud-calibrate"),N=document.getElementById("etud-toggleTracking"),O=document.getElementById("etud-log"),L.addEventListener("click",function(){fb(s.showOptions)}),M.addEventListener("click",function(){fb(s.calibrate)}),N.addEventListener("click",function(){fb(s.toggleTracking)})},j=function(b){if(J){var c=document.getElementById("etud-chgd-calibList");for(var d in b)if(!V[d]){V[d]=new m(d,q.customHeadGestureDetector);var e=document.createElement("li"),f=document.createElement("input");f.type="button",f.value=d.charAt(0).toUpperCase()+d.slice(1);var g=function(b,c){b.addEventListener("click",function(){a.etudriver.calibrateCustomHeadGesture(c,function(a){})})};g(f,d),e.appendChild(f),c.appendChild(e)}c.hasChildNodes()&&(document.getElementById("etud-chgd-calibMenu").style.display="inline")}},k=function(){Q=document.createElement("div"),Q.className="etud-pointer";var a=Q.style;a.display="none",a.backgroundColor=q.pointer.color,a.opacity=q.pointer.opacity,a.borderRadius=(q.pointer.size/2).toFixed(0)+"px",a.height=q.pointer.size+"px",a.width=q.pointer.size+"px",document.body.appendChild(Q)},l=Gb();$=l!==!1?l.path:"",Hb(!0,q,b),Hb(!0,r,c);var t=!1,u=!1,v={},w=function(b){switch(b.selection=Hb(!0,{},a.etudriver.settings.selection.defaults,b.selection),b.mapping=Hb(!0,{},a.etudriver.settings.mapping.defaults,b.mapping),b.selection.type){case a.etudriver.selection.cumulativeDwell:Hb(!0,!0,b.selection,a.etudriver.settings.selection.cumulativeDwell);break;case a.etudriver.selection.simpleDwell:Hb(!0,!0,b.selection,a.etudriver.settings.selection.simpleDwell);break;case a.etudriver.selection.nod:Hb(!0,!0,b.selection,a.etudriver.settings.selection.nod)}if(void 0!==b.selection.dwellTime&&(t=!0),b.selection.type===a.etudriver.selection.nod&&(u=!0),b.selection.type===a.etudriver.selection.customHeadGesture){var c=b.selection.name||"default";v[c]=!0}b.selection.audio&&(b.selection.audio=new Audio($+b.selection.audio))};for(var x in q.targets){var z=q.targets[x];w(z)}for(var A in a.etudriver.keyboard){var B=a.etudriver.keyboard[A];B.selection&&B.selection.type||(B.selection={type:a.etudriver.selection.cumulativeDwell}),w(B),B.name=A,W[A]=new n(B,y,{hide:function(){r.keyboard&&r.keyboard(X,!1),X=null,a.etudriver.updateTargets()},show:function(b){X=b,r.keyboard&&r.keyboard(X,!0),a.etudriver.updateTargets()}})}switch(q.mapping.type){case a.etudriver.mapping.expanded:Hb(!0,!0,q.mapping,a.etudriver.settings.mapping.expanded)}if(q.css.file){var C=$+q.css.file;q.css.useVersion&&l.version&&(C+="-"+l.version),C+=".css",g(C)}Ib(q.panel.show)&&i(),k(),t&&(R=document.createElement("canvas"),R.className="etud-progress",R.height=q.progress.size,R.width=q.progress.size,R.style.display="none",document.body.appendChild(R)),P=new d(q.fixdet),S=new e(q.headCorrector);var D={type:a.etudriver.selection.cumulativeDwell,className:"",duration:0,audio:"",dwellTime:800,showProgress:!1};q.scroller.targets={smooth:{selector:"."+q.scroller.className+"-smooth",selection:q.scroller.type===a.etudriver.scroller.fixation?D:{type:a.etudriver.selection.none},mapping:{className:""}},page:{selector:"."+q.scroller.className+"-page",selection:q.scroller.type===a.etudriver.scroller.fixation?D:{type:a.etudriver.selection.none},mapping:{className:""}}};for(var E in q.scroller.targets){var z=q.scroller.targets[E];w(z)}Y=new o(q.scroller),Z=new p(q.calibVerifier),Ib(q.pointer.smoothing.enabled)&&(T=new f(q.pointer.smoothing)),u&&(U=new h(a.etudriver.settings.selection.nod,q.headGesture)),j(v),a.etudriver.updateTargets(),eb(q.port)},a.etudriver.updateTargets=function(){x=[];var a,b,c,d=function(a,b){a.gaze={focused:!1,selected:!1,attention:0,selection:b.selection,mapping:b.mapping,keyboard:b.keyboard?W[b.keyboard]:null},x.push(a)};for(var e in q.targets)for(a=q.targets[e],b=document.querySelectorAll(a.selector),c=0;c<b.length;c+=1)d(b[c],a);if(X)for(a=X.options,b=X.getDOM().querySelectorAll("."+y.button),c=0;c<b.length;c+=1)d(b[c],a);for(var f in q.scroller.targets)for(a=q.scroller.targets[f],b=document.querySelectorAll(a.selector),c=0;c<b.length;c+=1)d(b[c],a)},a.etudriver.calibrateCustomHeadGesture=function(a,b){var c=V[a];return c?(c.init(c.modes.calibration,function(c){"finished"===c&&b&&b(a)}),!0):!1},a.etudriver.showOptions=function(){fb(s.showOptions)},a.etudriver.calibrate=function(){fb(s.calibrate)},a.etudriver.toggleTracking=function(){fb(s.toggleTracking)},a.etudriver.getKeyboard=function(a){return W[a]},a.etudriver.verifyCalibration=function(a,b){Z.run(a,b)};var s={showOptions:"SHOW_OPTIONS",calibrate:"CALIBRATE",toggleTracking:"TOGGLE_TRACKING",setDevice:"SET_DEVICE"},t={sample:"sample",state:"state",device:"device"},u={none:0,connected:1,calibrated:2,tracking:4,busy:8},v={disconnected:"DISCONNECTED",connecting:"CONNECTING...",connected:"CONNECTED"},w={device:{id:"etudriver-device","default":"Mouse"}},x=[],y={button:"etud-keyboard-keyMarker",indicator:"etud-keyboard-indicator"},z=0,A=null,B=null,C=null,D=null,E=u.none,F="",G=[],H=0,I=0,J=null,K=null,L=null,M=null,N=null,O=null,P=null,Q=null,R=null,S=null,T=null,U=null,V={},W={},X=null,Y=null,Z=null,$="",_=null,ab=function(){if(J){gb(v.connected),J.classList.add(q.panel.connectedClassName);var a=tb(u.none);sb(a);var b=getStoreValue(w.device);b&&fb(s.setDevice+" "+b)}},bb=function(){if(_=null,J){F="",gb(v.disconnected),J.classList.remove(q.panel.connectedClassName);var a=tb(u.none);sb(a)}},cb=function(a){try{var b,c=JSON.parse(a.data);c.type===t.sample?z?G.push({ts:c.ts,x:c.x,y:c.y,pupil:c.p,ec:c.ec}):ib(c.ts,c.x,c.y,c.p,c.ec):c.type===t.state?(vb("onWebSocketMessage","WebSocket got state: "+a.data),b=tb(c.value),hb(b)):c.type===t.device&&(vb("onWebSocketMessage","WebSocket got device: "+a.data),yb(w.device,c.name),b=tb(void 0,c.name),hb(b))}catch(d){wb("onWebSocketMessage",d),wb("onWebSocketMessage",a.data)}},db=function(a){vb("onWebSocketError",a),O&&(O.innerHTML="Problems in the connection to WebSocket server",setTimeout(function(){O.innerHTML=""},5e3))},eb=function(a){gb(v.connecting);var b="ws://localhost:"+a+"/";_=new WebSocket(b),_.onopen=ab,_.onclose=bb,_.onmessage=cb,_.onerror=db},fb=function(a){vb("sendToWebSocket","WebSocket sent: "+a),_.send(a)},gb=function(a){K&&(K.innerHTML=a)},hb=function(b){Bb(),J&&sb(b),Ib(q.pointer.show)&&(Q.style.display=b.isTracking?"block":"none"),R&&(R.style.display=b.isTracking?"block":"none"),"function"==typeof r.state&&r.state(b);var c,d;if(b.isTracking){q.frequency>=10&&q.frequency<=100&&(z=setTimeout(ub,1e3/q.frequency),I=(new Date).getTime(),H=0),T&&T.init(),Y&&Y.init(),A=null,B=null,C=null,D=null,a.etudriver.updateTargets(),P.reset();for(c in V)d=V[c],d.init(d.modes.detection)}else{for(c in V)d=V[c],d.finilize();z&&(clearTimeout(z),z=0);var e;for(e=0;e<x.length;e+=1){var f=x[e];f.gaze.focused=!1,f.gaze.selected=!1,f.gaze.mapping.className&&f.classList.remove(f.gaze.mapping.className)}X&&X.hide(),b.isStopped&&Y&&Y.reset()}},ib=function(b,c,d,e,f){var g=Cb(c,d);if(Z.isActive()&&Z.feed(b,c,d),Ib(q.headCorrector.enabled)&&f&&(D||S.init(f),g=S.correct(g,f)),"function"==typeof r.sample&&r.sample(b,g.x,g.y,e,f),J&&Ib(q.panel.displaySamples)){var h=function(a,b){for(var c=a+",";c.length<b;)c+=" ";return c},i="t = "+h(b,6)+" x = "+h(g.x,5)+" y = "+h(g.y,5)+" p = "+h(e,4);if(void 0!==f){i+="ec: { ";var j;for(j in f)i+=j+" = "+f[j]+", ";i+="}"}O.innerHTML=i}if(P.feed(b,g.x,g.y),kb(q.mapping.type,g.x,g.y),f){var k;U&&(k=A&&A.gaze.selection.type===a.etudriver.selection.nod,U.feed(b,g.x,g.y,e,f,k?A:null));for(var l in V){var m=V[l];k=A&&A.gaze.selection.type===a.etudriver.selection.customHeadGesture&&A.gaze.selection.name===m.getName(),m.feed(b,f,k?A:null)}q.scroller.type===a.etudriver.scroller.headPose&&Y.feed(f)}if(nb(b,g.x,g.y,e,f),B&&rb(Ib(B.gaze.selection.showProgress)?B:null),Ib(q.pointer.show)){"block"!==Q.style.display&&(Q.style.display="block");var n={x:0,y:0};q.mapping.source==a.etudriver.source.samples?(n.x=g.x,n.y=g.y):q.mapping.source==a.etudriver.source.fixations&&P.currentFix&&(n.x=P.currentFix.x,n.y=P.currentFix.y),T&&(n=T.smooth(b,n.x,n.y)),Q.style.left=n.x-q.pointer.size/2+"px",Q.style.top=n.y-q.pointer.size/2+"px"}else"none"!==Q.style.display&&(Q.style.display="none");D={ts:b,x:c,y:d,pupil:e,ec:f}},jb=function(a){var b=!!X&&!a.classList.contains(y.button)||"hidden"===a.style.visibility||a.classList.contains(y.indicator);return b},kb=function(b,c,d){var e=a.etudriver.mapping,f=a.etudriver.source,g=null;switch(q.mapping.source==f.fixations&&P.currentFix&&(c=P.currentFix.x,d=P.currentFix.y),b){case e.naive:g=lb(c,d);break;case e.expanded:g=mb(c,d)}if(g!==A){var h;A&&(A.gaze.focused=!1,A.gaze.mapping.className&&A.classList.remove(A.gaze.mapping.className),h=new Event(a.etudriver.event.left),A.dispatchEvent(h),"function"==typeof r.target&&r.target(a.etudriver.event.left,A)),g&&(g.gaze.focused=!0,g.gaze.mapping.className&&g.classList.add(g.gaze.mapping.className),h=new Event(a.etudriver.event.focused),g.dispatchEvent(h),"function"==typeof r.target&&r.target(a.etudriver.event.focused,g),qb(g)),A=g,A&&(B=A)}},lb=function(a,b){var c,d=null;for(c=0;c<x.length;c+=1){var e=x[c];if(!jb(e)){var f=e.getBoundingClientRect();if(a>=f.left&&a<f.right&&b>=f.top&&b<f.bottom)if(d){if(document.elementFromPoint(a,b)===e){d=e;break}}else d=e}}return d},mb=function(a,b){var c,d=null,e=Number.MAX_VALUE;for(c=0;c<x.length;c+=1){var f=x[c];if(!jb(f)){var g=f.getBoundingClientRect(),h=a<g.left?g.left-a:a>g.right?a-g.right:0,i=b<g.top?g.top-b:b>g.bottom?b-g.bottom:0,j=Math.sqrt(h*h+i*i);if(e>j&&j<q.mapping.expansion)d=f,e=j;else if(0===j&&document.elementFromPoint(a,b)===f){d=f;break}}}return d},nb=function(b){var c,d=a.etudriver.selection,e=null;for(c=0;c<x.length;c+=1){var f=x[c];if(!jb(f)){switch(f.gaze.selection.type){case d.cumulativeDwell:D&&ob(f,b-D.ts)&&(e=f);break;case d.simpleDwell:P.currentFix&&D&&pb(f,b-D.ts)&&(e=f);break;case d.nod:e=U.current;break;case d.customHeadGesture:for(var g in V){var h=V[g];e=h.current||e}}if(e)break}}if(e!==C){if(C&&(C.gaze.selected=!1),e){e.gaze.selected=!0,e.gaze.selection.className&&(e.classList.add(e.gaze.selection.className),setTimeout(function(){e.classList.remove(e.gaze.selection.className)},e.gaze.selection.duration)),e.gaze.selection.audio&&e.gaze.selection.audio.play();var i=new Event(a.etudriver.event.selected);e.dispatchEvent(i),"function"==typeof r.target&&r.target(a.etudriver.event.selected,e),e.gaze.keyboard&&e.gaze.keyboard.show(e)}C=e}},ob=function(b,c){var d,e=!1;if(b===A){if(b.gaze.attention+=c,b.gaze.attention>=b.gaze.selection.dwellTime)for(e=!0,d=0;d<x.length;d+=1){var f=x[d];f.gaze.selection.type===a.etudriver.selection.cumulativeDwell&&(f.gaze.attention=0)}}else b.gaze.attention=Math.max(0,b.gaze.attention-c);return e},pb=function(b,c){var d=!1;if(b===A){b.gaze.attention+=c;for(var e=0;e<x.length;e+=1){var f=x[e];f.gaze.selection.type===a.etudriver.selection.simpleDwell&&f!==b&&(f.gaze.attention=0)}b.gaze.attention>=b.gaze.selection.dwellTime&&(d=!0,b.gaze.attention=0)}else b.gaze.attention=0;return d},qb=function(a){if(R&&"undefined"!=typeof a.gaze.selection.dwellTime){var b=a.getBoundingClientRect();R.style.left=Math.round(b.left+(b.width-q.progress.size)/2)+"px",R.style.top=Math.round(b.top+(b.height-q.progress.size)/2)+"px"}},rb=function(a){if(R){var b=R.getContext("2d"),c=q.progress.size;if(b.clearRect(0,0,c,c),a){var d=Math.min(1,(a.gaze.attention-q.progress.delay)/(a.gaze.selection.dwellTime-q.progress.delay));d>0&&(b.beginPath(),b.lineWidth=Math.max(q.progress.minWidth,c/10),b.arc(c/2,c/2,.45*c,-.5*Math.PI,-.5*Math.PI+2*Math.PI*d),b.strokeStyle=q.progress.color,b.stroke())}}},sb=function(a){a.device&&(K.innerHTML=a.device),L.disabled=!_||a.isTracking||a.isBusy,M.disabled=!a.isConnected||a.isTracking||a.isBusy,N.disabled=!a.isCalibrated||a.isBusy,N.value=a.isTracking?"Stop":"Start",!a.isTracking&&a.isCalibrated&&(O.innerHTML="")},tb=function(a,b){var c=!1;return void 0!==a?(c=(E&u.tracking)>0&&0===(a&u.tracking),E=a):a=E,void 0!==b?F=b:b=F,{isServiceRunning:!!_,isConnected:(E&u.connected)>0,isCalibrated:(E&u.calibrated)>0,isTracking:(E&u.tracking)>0,isBusy:(E&u.busy)>0,isStopped:c,device:F}},ub=function(){H+=1;var a=null;if(G.length){for(var b=0,c=0,d=0,e={xl:0,yl:0,xr:0,yr:0},f=0;f<G.length;f+=1){var g=G[f];b+=g.x,c+=g.y,d+=g.pupil,g.ec&&(e.xl+=g.ec.xl,e.yl+=g.ec.yl,e.xr+=g.ec.xr,e.yr+=g.ec.yr)}a={ts:Math.round(H*(1e3/q.frequency)),x:b/G.length,y:c/G.length,pupil:d/G.length,ec:{xl:e.xl/G.length,yl:e.yl/G.length,xr:e.xr/G.length,yr:e.yr/G.length}},G=[]}else D&&(a=D);a&&ib(a.ts,a.x,a.y,a.pupil,a.ec);var h=(new Date).getTime(),i=Math.round(I+(H+1)*(1e3/q.frequency)),j=Math.max(0,i-h);z=setTimeout(ub,j)},vb=function(){var a=Array.prototype.join.call(arguments,": ");console.log(a)},wb=function(){var a=Array.prototype.join.call(arguments,": ");console.error(a)},xb=function(){var a=!0;try{a=!!localStorage}catch(b){a=!1}return a},yb=function(a,b){xb()&&(localStorage[a.id]=b)},zb={x:1,y:1},Ab={x:0,y:0},Bb=function(){if("undefined"==typeof devicePixelRatio){var a=function(a){var b,c,d=0,e=function(a,b,c){for(var e=window.matchMedia;a>=b&&!e("(min-resolution: "+a/c+"dppx)").matches;)a-=1,d+=1;return a},f=5,g=.1,h=1;for(c=0;a>c;c+=1)b=10*e(f,g,h),f=b+9,g=b,h*=10;return b/h}(5);zb={x:a,y:a}}else zb={x:devicePixelRatio,y:devicePixelRatio};if(window.mozInnerScreenX)Ab={x:window.mozInnerScreenX*zb.x,y:window.mozInnerScreenY*zb.y};else{var b=window.innerWidth*zb.x,c=window.innerHeight*zb.y;Ab={x:window.screenX+(window.outerWidth-b)/2,y:window.screenY+(window.outerHeight-c)-(window.outerWidth-b)/2}}},Cb=function(a,b){return{x:(a-Ab.x)/zb.x,y:(b-Ab.y)/zb.y}},Db=function(){var a;return a=window.mozInnerScreenX?{width:Math.round(screen.width*zb.x),height:Math.round(screen.height*zb.y)}:{width:screen.width,height:screen.height}},Eb=function(){var a=arguments.length>1?arguments[0]:0,b=arguments.length>0?arguments[arguments.length-1]:4294967295;return Math.floor(Math.random()*(b-a+.99999))+a},Fb=function(a){if(null==a||"object"!=typeof a)return a;if(a instanceof Date){var b=new Date;return b.setTime(a.getTime()),b}if(a instanceof Array){for(var b=[],c=0,d=a.length;d>c;c++)b[c]=Fb(a[c]);return b}if(a instanceof Object){var b=a.constructor();for(var e in a)a.hasOwnProperty(e)&&(b[e]=a[e]===a?b:Fb(a[e]));return b}return void 0},Gb=function(){var a,b=function(a){function c(a){for(var b="";a;)if("../"===a.substr(0,3)||"./"===a.substr(0,2))a=a.replace(/^\.+/,"").substr(1);else if("/./"===a.substr(0,3)||"/."===a)a="/"+a.substr(3);else if("/../"===a.substr(0,4)||"/.."===a)a="/"+a.substr(4),b=b.replace(/\/?[^\/]*$/,"");else if("."===a||".."===a)a="";else{var c=a.match(/^\/?[^\/]*/)[0];a=a.substr(c.length),b+=c}return b}this.scheme=null,this.authority=null,this.path="",this.query=null,this.fragment=null,this.parse=function(a){var b=a.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);return this.scheme=b[3]?b[2]:null,this.authority=b[5]?b[6]:null,this.path=b[7],this.query=b[9]?b[10]:null,this.fragment=b[12]?b[13]:null,this},this.toString=function(){var a="";return null!==this.scheme&&(a=a+this.scheme+":"),null!==this.authority&&(a=a+"//"+this.authority),null!==this.path&&(a+=this.path),null!==this.query&&(a=a+"?"+this.query),null!==this.fragment&&(a=a+"#"+this.fragment),a},this.toAbsolute=function(a){a=new b(a);var d=this,e=new b;return null===a.scheme?!1:(null!==d.scheme&&d.scheme.toLowerCase()===a.scheme.toLowerCase()&&(d.scheme=null),null!==d.scheme?(e.scheme=d.scheme,e.authority=d.authority,e.path=c(d.path),e.query=d.query):(null!==d.authority?(e.authority=d.authority,e.path=c(d.path),e.query=d.query):(""===d.path?(e.path=a.path,e.query=null!==d.query?d.query:a.query):("/"===d.path.substr(0,1)?e.path=c(d.path):(e.path=null!==a.authority&&""===a.path?"/"+d.path:a.path.replace(/[^\/]+$/,"")+d.path,e.path=c(e.path)),e.query=d.query),e.authority=a.authority),e.scheme=a.scheme),e.fragment=d.fragment,e)},a&&this.parse(a)},c=location.href,d=document.getElementsByTagName("base");for(a=0;a<d.length;a+=1)d[a].href&&(c=d[a].href);var e=/(^|\/)etudriver(-(\d+)\.(\d+)\.(\d+))?\.js([?#].*)?$/i;for(d=document.getElementsByTagName("script"),a=0;a<d.length;a+=1)if(d[a].src){var f=e.exec(d[a].src);if(f){var g=new b(d[a].src),h=g.toAbsolute(c);return h.path=h.path.replace(/[^\/]+$/,""),h.query=null,h.fragment=null,{path:h.toString(),version:"undefined"!=typeof f[2]?f[3]+"."+f[4]+"."+f[5]:""}}}return!1},Hb=function(){var a,b,c,d,e,f,g=function(a){return"object"!=typeof a||a.nodeType||a===a.window?!1:!0},h=arguments[0]||{},i=1,j=arguments.length,k=!1,l=!1;if("boolean"==typeof h&&(k=h,h=arguments[i]||{},i+=1),"boolean"==typeof h&&(l=h,h=arguments[i]||{},i+=1),"object"!=typeof h&&"function"!=typeof h&&(h={}),j===i)return h;for(;j>i;i+=1)if(null!=(a=arguments[i]))for(b in a)c=h[b],d=a[b],h!==d&&(k&&d&&(g(d)||(e=Array.isArray(d)))?(e?(e=!1,f=c&&Array.isArray(c)?c:[]):f=c&&g(c)?c:{},h[b]=Hb(k,f,d)):void 0!==d&&(l&&void 0!==h[b]||(h[b]=d)));return h},Ib=function(a){return"function"==typeof a?a():!!a};b.prototype.request=function(a){a.requestFullscreen?a.requestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen&&a.msRequestFullscreen()},b.prototype.exit=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen){var a=document.mozFullScreenElement,b=a.parentNode;b.removeChild(a),b.appendChild(a)}else document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},Object.defineProperty(b.prototype,"isActive",{get:function(){return document.fullscreenElement||document.mozFullScreenElement||window.fullScreen||document.webkitFullscreenElement||document.msFullscreenElement}}),b.prototype.addEventListener=function(a,b){var c="fullscreen",d=function(a){return Array.prototype.map.apply(a,[function(a,b){return 0===b?a.toUpperCase():a}]).join("")};document.addEventListener(c+a,b),document.addEventListener("webkit"+c+a,b),document.addEventListener("moz"+c+a,b),document.addEventListener("MS"+d(c)+d(a),b)},c.prototype.addSample=function(a,b,c,d){this.samples.length==a&&this.samples.shift(),this.samples.push({x:c,y:d}),this.duration=b-this.ts;for(var e=0,f=0,g=0;g<this.samples.length;g+=1){var h=this.samples[g];e+=h.x,f+=h.y}this.x=e/this.samples.length,this.y=f/this.samples.length},g.prototype.isMatched=function(a){var b=1<<a;return(this.matched&b)>0},g.prototype.setMatched=function(a,b){var c=~(1<<a);this.matched=(this.matched&c)+(b?1<<a:0)},h.prototype.init=function(){this.buffer=[],this.eventIsOn=!1,this.canTest=!1,this.current=null},h.prototype.feed=function(a,b,c,d,e){var f=null;if(d){for(var h=0;h<this.buffer.length&&a-this.buffer[h].ts>this.settings.timeWindow;h++)this.buffer.shift(),this.canTest=!0;this.canTest=this.canTest&&this.buffer.length>0;var i=new g(a,b,c,d,e);this.canTest&&this.test(i),this.buffer.push(i),this.canTest&&(f=this.searchPattern())}return this.current=f?f.object:null,f},h.prototype.isRangeTestable=function(a){return 0!==a.min||0!==a.max},h.prototype.normalizeAngles=function(a,b){var c=a.min,d=a.max;return 0===c&&0===d?d=360:c>d&&(180>b?c=0:d=360),{min:c,max:d}},h.prototype.testRule=function(a,b,c,d){var e=!1,f=this.normalizeAngles(a[b].angle,d),g=a[b].amplitude;return e=c>=g.min&&c<=g.max&&d>=f.min&&d<=f.max},h.prototype.test=function(a){var b;for(b=0;b<this.rules.length;b+=1){for(var c=this.rules[b],d=this.buffer.length-1,e=a.ts-c.interval.max,f=a.ts-c.interval.min;d>=0&&this.buffer[d].ts>f;)d-=1;for(var g=c.matchAll;d>=0&&this.buffer[d].ts>e;){var h=this.buffer[d];d-=1;var i=a.ec.xl-h.ec.xl,j=a.ec.yl-h.ec.yl,k=a.ec.xr-h.ec.xr,l=a.ec.yr-h.ec.yr,m=Math.sqrt(i*i+j*j),n=180*Math.atan2(j,i)/Math.PI,o=Math.sqrt(k*k+l*l),p=180*Math.atan2(l,k)/Math.PI;0>n&&(n+=360),0>p&&(p+=360);var q=(this.isRangeTestable(c.left.amplitude)?this.testRule(c,"left",m,n):!0)&&(this.isRangeTestable(c.right.amplitude)?this.testRule(c,"right",o,p):!0);if(c.matchAll){if(g=g&&q,!q)break}else if(g=g||q,q)break}a.setMatched(b,g)}vb&&vb(a.matched)},h.prototype.searchPattern=function(){var a,b=null,c=this.rules.length-1,d=-1,e=0,f=null,g=null;for(a=this.buffer.length-1;a>=0;a-=1){var h=this.buffer[a];if(h.isMatched(c)){if(e>0&&e-h.ts>this.rules[d].interval.max)break;if(c===this.rules.length-1)g=h;else if(0===c){for(var i=h.ts-this.rules[0].interval.max;a>0&&this.buffer[a-1].ts>i;)a-=1;f=this.buffer[a];break}e=h.ts,d=c,c-=1}else d>=0&&h.isMatched(d)&&(e=h.ts)}var j=0,k=0;for(a=0;a<this.rules.length;a+=1){var l=this.rules[a];j+=l.interval.max,k+=l.interval.min}var m=f&&g&&g.ts-f.ts<j&&g.ts-f.ts>k?!0:!1;if(m&&!this.eventIsOn)for(b={name:"nod",object:f.focused};this.buffer.length>0;){var n=this.buffer[0];if(!(n.ts<g.ts))break;this.buffer.shift()}return this.eventIsOn=m,b},h.prototype.computeEyeGazePoints=function(a){for(var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=Math.max(a,9),l=this.buffer[k].ts,m=l;150>l-m&&k>=0;){var n=this.buffer[k];b+=n.x,c+=n.y,d+=1,n.ec.xl>0&&(e+=n.ec.xl,f+=n.ec.yl,g+=1),n.ec.xr>0&&(h+=n.ec.xr,i+=n.ec.yr,j+=1),m=n.ts,k-=1}return d>0&&(b/=d,c/=d),g>0&&(e/=g,f/=g),j>0&&(h/=j,i/=j),{gaze:{x:b,y:c},eye:{left:{x:e,y:f},right:{x:h,y:i}}}},i.prototype.isSet=function(){return!(0===this.ec.xl&&0===this.ec.yl&&0===this.ec.xr&&0===this.ec.yr)},i.prototype.isValid=function(){return-1!==this.timestamp}}(window);